name: Verify Beta Deployment

on:
  workflow_run:
    workflows: ["Deploy Preview"]
    types:
      - completed

jobs:
  verify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          npm install -g @lhci/cli
          npm install @playwright/test
          npx playwright install --with-deps chromium

      - name: Construct Beta URL
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          URL="https://${{ github.repository_owner }}.github.io/$REPO_NAME/beta/"
          echo "BETA_URL=$URL" >> $GITHUB_ENV
          echo "Testing URL: $URL"

      - name: IQ - Installation Qualification
        run: |
          echo "Checking reachability of $BETA_URL"
          # Retry loop for IQ because deployment might take a few seconds to propagate
          for i in {1..5}; do
            HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" "$BETA_URL")
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "IQ Passed: HTTP Status is 200"
              exit 0
            fi
            echo "Attempt $i: HTTP Status is $HTTP_STATUS. Retrying in 10s..."
            sleep 10
          done
          echo "IQ Failed: Could not verify site is up after 5 attempts."
          exit 1

      - name: OQ - Operational Qualification
        env:
          BETA_URL: ${{ env.BETA_URL }}
        run: |
          npx playwright test tests/verification.spec.js

      - name: PQ - Performance Qualification
        run: |
          lhci collect --url="${{ env.BETA_URL }}" --numberOfRuns=1
          lhci assert --preset="lighthouse:no-pwa" --assertions.performance.minScore=0.9 --assertions.accessibility.minScore=0.9
