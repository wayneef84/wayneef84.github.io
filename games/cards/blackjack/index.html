<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blackjack - Founding & Forging</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        html, body { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%;
            overflow: hidden; /* Main container logic */
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: 
                radial-gradient(circle at 50% 30%, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.1) 60%),
                radial-gradient(ellipse at center, #27773f 0%, #154622 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 100%);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
            height: 50px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.1em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance {
            font-family: "Courier New", monospace;
            font-weight: bold;
            color: #ffd700;
            background: rgba(0,0,0,0.6);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid #ffd700;
        }

        .settings-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
        }

        /* --- TABLE AREA (Scrollable) --- */
        .table {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Space between dealer (top) and player (bottom) */
            padding: 15px;
            padding-bottom: 200px; /* IMPORTANT: Extra padding so cards don't hide behind footer */
            overflow-y: auto; /* Allow scrolling if dealer has many cards */
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* Message Overlay - Positioned in center/middle */
        .message-container {
            position: absolute;
            top: 50%; /* Center vertically */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            text-align: center;
            pointer-events: none;
            width: 100%;
            max-width: 400px;
        }
        
        .message {
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            padding: 15px 30px;
            border-radius: 12px;
            display: inline-block;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0.8);
        }
        
        /* Message Animations */
        .message.visible { opacity: 1; transform: scale(1); }
        .message.win { color: #fff; background: rgba(34, 197, 94, 0.95); border: 2px solid #86efac; box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); animation: winPulse 0.5s ease-out; }
        .message.lose { color: #fff; background: rgba(239, 68, 68, 0.95); border: 2px solid #fca5a5; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); animation: loseShake 0.4s ease-out; }
        .message.push { color: #fff; background: rgba(234, 179, 8, 0.95); border: 2px solid #fde047; }
        .message.blackjack { color: #000; background: linear-gradient(135deg, #ffd700, #fbbf24); border: 3px solid #fff; font-size: 2.5em; text-shadow: none; animation: blackjackBounce 0.6s ease-out; }

        @keyframes winPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes loseShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        @keyframes blackjackBounce {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); }
            70% { transform: scale(0.9) rotate(-2deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        /* Hand Areas */
        .hand-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 140px;
            position: relative;
        }

        /* Dealer area anchored at top */
        .dealer-area {
            margin-bottom: auto; /* Push to top */
        }

        /* Player area anchored at bottom */
        .player-area {
            margin-top: auto; /* Push to bottom */
        }

        .hand-area h3 {
            margin: 0;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
        }

        /* Dealer label spacing - match player spacing */
        .dealer-area h3 {
            margin-bottom: 10px;
        }

        .cards-container {
            display: flex;
            justify-content: center;
            height: 120px;
            position: relative;
        }
        
        /* Card Slots */
        .card-slot {
            width: 86px;
            height: 120px;
            margin: 0 -25px; /* Overlap */
            transition: margin 0.3s;
            position: relative;
        }

        /* Face-up (revealed) cards move 1/8 card closer to player (downward) */
        #dealerCards .card-slot:not(.face-down) {
            margin-top: 15px; /* 1/8 of 120px card height */
        }

        .card-slot.placeholder {
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.1);
            margin: 0 5px;
        }
        
        .card-slot canvas {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.3);
        }
        
        .hand-value {
            margin: 8px 0;
            background: rgba(0,0,0,0.5);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Hide value bubble when empty/no value */
        .hand-value.hidden-value {
            display: none;
        }

        /* Hide value bubble if no cards or value is 0 */
        .hand-value.hidden-value {
            display: none;
        }

        /* Player area: Bottom-Up layout (Cards ‚Üí Value ‚Üí Label) */
        #playerArea {
            flex-direction: column-reverse;
        }

        #playerArea h3 {
            margin-top: 10px; /* Space above "You" label */
        }

        #playerArea .hand-value {
            margin-top: 0;
            margin-bottom: 8px; /* Space below value bubble */
        }
        
        .hand-value.bust { background: #ef4444; border-color: #ff0000; }
        .hand-value.blackjack { background: #ffd700; color: #000; border-color: #fff; }
        .hand-value.max { background: #3b82f6; border-color: #60a5fa; box-shadow: 0 0 10px #3b82f6; } 

        /* --- FIXED FOOTER CONTROLS --- */
        .controls {
            position: fixed; /* PINNED TO BOTTOM */
            bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(15px);
            padding: 15px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid rgba(255,255,255,0.15);
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .hidden { display: none !important; }
        
        /* CHIP UI */
        .chip-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
            margin-bottom: 5px;
        }

        .chip {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 4px dashed rgba(255,255,255,0.5);
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.1s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            position: relative;
        }

        .chip:active { transform: scale(0.9); }
        
        .chip-1 { background: #ef4444; border-color: #fca5a5; }
        .chip-5 { background: #3b82f6; border-color: #93c5fd; }
        .chip-25 { background: #10b981; border-color: #86efac; }
        .chip-50 { background: #f97316; border-color: #fdba74; }
        
        /* Gold $100 Chip */
        .chip-100 { 
            background: radial-gradient(circle, #ffd700 20%, #b8860b 100%);
            border: 3px solid #fff;
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        }

        /* Clear X Chip */
        .chip-clear {
            background: #334155;
            border-color: #475569;
            color: #f87171;
            font-size: 1.2rem;
        }

        .bet-display {
            color: #ffd700;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        /* ACTION BUTTONS */
        button.action-btn {
            background: linear-gradient(180deg, #f1f5f9 0%, #cbd5e1 100%);
            border: 1px solid #94a3b8;
            border-radius: 8px;
            padding: 14px;
            font-size: 1rem;
            font-weight: 800;
            color: #0f172a;
            cursor: pointer;
            box-shadow: 0 4px 0 #94a3b8;
            transition: all 0.1s;
            flex: 1;
            text-transform: uppercase;
            touch-action: manipulation;
        }
        
        button.action-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #94a3b8; }

        button.utility-btn {
            background: linear-gradient(180deg, #6366f1 0%, #4f46e5 100%);
            border: 1px solid #4338ca;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 3px 0 #4338ca;
            transition: all 0.1s;
            width: 100%;
            max-width: 400px;
            margin: 8px 0;
            text-transform: none;
            touch-action: manipulation;
        }

        button.utility-btn:active { transform: translateY(3px); box-shadow: 0 0 0 #4338ca; }

        button.primary {
            background: linear-gradient(180deg, #4ade80 0%, #16a34a 100%);
            border-color: #15803d;
            box-shadow: 0 4px 0 #15803d;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        button.primary:active { box-shadow: 0 0 0 #15803d; }
        
        button.danger {
            background: linear-gradient(180deg, #f87171 0%, #dc2626 100%);
            border-color: #991b1b;
            box-shadow: 0 4px 0 #991b1b;
            color: white;
        }
        button.danger:active { box-shadow: 0 0 0 #991b1b; }

        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #475569;
        }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .setting-row label { color: #e2e8f0; }
        .setting-row input { background: #0f172a; color: white; border: 1px solid #475569; padding: 8px; border-radius: 6px; width: 80px; text-align: center; }
        .button-row { display: flex; gap: 10px; margin-top: 10px; }
        .half-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; background: #3b82f6; color: white; }
        .half-btn:active { transform: scale(0.98); }
        .full-btn { width: 100%; margin-top: 10px; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .reset-funds { background: #ef4444; color: white; }
        .close-btn { background: #ffd700; color: black; }

        /* Debug Overlay */
        .debug-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .debug-panel {
            background: #0f172a;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 2px solid #ef4444;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
        }
        .debug-panel h2 {
            color: #ef4444;
            margin: 0 0 15px 0;
            font-size: 1.3rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .debug-panel p {
            color: #94a3b8;
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 20px;
        }
        .debug-commands {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .debug-btn {
            background: linear-gradient(180deg, #334155 0%, #1e293b 100%);
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .debug-btn:hover {
            background: linear-gradient(180deg, #475569 0%, #334155 100%);
            border-color: #64748b;
        }
        .debug-btn:active {
            transform: scale(0.98);
        }
        .debug-btn.danger {
            background: linear-gradient(180deg, #7f1d1d 0%, #450a0a 100%);
            border-color: #991b1b;
            color: #fca5a5;
        }
        .debug-close {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        /* History Modal */
        .history-modal {
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .history-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #334155;
        }
        .history-tab {
            flex: 1;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #94a3b8;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-tab.active {
            color: #fbbf24;
            border-bottom-color: #fbbf24;
        }
        .history-panel {
            min-height: 250px;
        }
        .card-count-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .count-row {
            display: grid;
            grid-template-columns: 50px 1fr 1fr;
            align-items: center;
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #334155;
            gap: 12px;
        }
        .count-row .count-label {
            color: #94a3b8;
            font-weight: bold;
            text-align: left;
        }
        .count-row .count-value {
            color: #fbbf24;
            font-weight: bold;
            text-align: center;
        }
        .count-row .count-prob {
            color: #4ade80;
            font-size: 0.85rem;
            text-align: center;
        }
        .shoe-info {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #475569;
            text-align: center;
            color: #e2e8f0;
            font-size: 0.9rem;
        }
        .shoe-info span {
            color: #fbbf24;
            font-weight: bold;
        }
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .history-hand {
            background: rgba(0,0,0,0.3);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .history-hand:last-child {
            margin-bottom: 0;
        }
        .history-hand-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #475569;
        }
        .history-hand-num {
            color: #94a3b8;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .history-hand-result {
            font-weight: bold;
            font-size: 0.95rem;
        }
        .history-hand-result.win { color: #4ade80; }
        .history-hand-result.lose { color: #f87171; }
        .history-hand-result.push { color: #fbbf24; }
        .history-hand-result.blackjack { color: #ffd700; }
        .history-hand-payout {
            font-size: 0.85rem;
            font-weight: bold;
        }
        .history-hand-payout.win { color: #4ade80; }
        .history-hand-payout.lose { color: #f87171; }
        .history-hand-payout.push { color: #94a3b8; }
        .history-cards-row {
            margin-bottom: 8px;
        }
        .history-cards-label {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .history-cards {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .history-card {
            background: #fff;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            border: 1px solid #334155;
        }
        .history-card.red {
            color: #dc2626;
        }
        .history-value {
            color: #e2e8f0;
            font-size: 0.85rem;
            margin-top: 4px;
        }
        .no-history {
            padding: 40px;
            text-align: center;
            color: #64748b;
            font-style: italic;
        }

        /* Insurance Modal */
        .insurance-modal {
            text-align: center;
            border: 2px solid #fbbf24;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
        }
        .rules-modal {
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .rules-content {
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .rules-content h3 {
            color: #fbbf24;
            margin: 1rem 0 0.5rem;
            font-size: 1rem;
        }
        .rules-content p, .rules-content ul, .rules-content ol {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }
        .rules-content li {
            margin: 0.25rem 0;
        }
        .rules-settings-header {
            margin-top: 1.5rem !important;
            padding-top: 1rem;
            border-top: 1px solid #444;
        }
        .rules-settings {
            background: rgba(0,0,0,0.3);
            padding: 0.75rem 1rem !important;
            border-radius: 8px;
        }
        .rules-settings strong {
            color: #4ade80;
        }

        .insurance-modal h2 {
            color: #fbbf24;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
        }
        .insurance-modal p {
            color: #e2e8f0;
            margin: 10px 0;
            font-size: 0.95rem;
        }
        .insurance-info {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #475569;
            font-size: 0.9rem;
        }
        .insurance-info span {
            color: #fbbf24;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .insurance-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .insurance-actions .action-btn {
            flex: 1;
        }

    </style>
</head>
<body>
    <header class="header">
        <h1>
            <button id="btnRules" class="settings-btn">üìñ</button>
            <button id="btnHistory" class="settings-btn">üìä</button>
            <button id="btnSettings" class="settings-btn">‚öôÔ∏è</button>
            Blackjack
        </h1>
        <div class="balance">$<span id="balance">1000</span></div>
    </header>

    <main class="table">
        <!-- Dealer Section (anchored at top) -->
        <div class="hand-area dealer-area" id="dealerArea">
            <h3>Dealer</h3>
            <div class="hand-value" id="dealerValue">-</div>
            <div class="cards-container" id="dealerCards"></div>
        </div>

        <!-- Message (center/middle) -->
        <div class="message-container">
            <div id="message" class="message"></div>
        </div>

        <!-- Player Section (anchored at bottom) -->
        <div class="hand-area player-area" id="playerArea">
            <div class="cards-container" id="playerCards"></div>
            <div class="hand-value" id="playerValue">-</div>
            <h3>You</h3>
        </div>
    </main>

    <footer class="controls">
        <div id="bettingRow" class="control-row" style="flex-direction: column; align-items: center;">
            <div class="bet-display">Bet: $<span id="currentBetDisplay">25</span></div>
            
            <div class="chip-container">
                <div class="chip chip-1" data-val="1">1</div>
                <div class="chip chip-5" data-val="5">5</div>
                <div class="chip chip-25" data-val="25">25</div>
                <div class="chip chip-50" data-val="50">50</div>
                <div class="chip chip-100" data-val="100">100</div>
                <div class="chip chip-clear" id="btnClearBet">‚úï</div>
            </div>

            <button id="btnResetDeckBetting" class="utility-btn">üîÑ Reset Deck</button>
            <button id="btnDeal" class="action-btn primary" style="width: 100%; max-width: 400px;">DEAL HAND</button>
        </div>

        <div id="actionRow" class="control-row hidden">
            <button id="btnHit" class="action-btn primary">HIT</button>
            <button id="btnStand" class="action-btn danger">STAND</button>
            <button id="btnDouble" class="action-btn">DOUBLE</button>
        </div>

        <div id="gameOverRow" class="control-row hidden">
            <button id="btnPlayAgain" class="action-btn primary">PLAY AGAIN (<span id="lastBetAmount">$25</span>)</button>
            <button id="btnNew" class="action-btn">CHANGE BET</button>
        </div>
    </footer>

    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal history-modal">
            <h2>üìä Game History</h2>

            <div class="history-tabs">
                <button id="tabCardCount" class="history-tab active">Card Count</button>
                <button id="tabHandHistory" class="history-tab">Hand History</button>
            </div>

            <div id="cardCountPanel" class="history-panel">
                <div class="card-count-grid">
                    <div class="count-row"><span class="count-label">A:</span><span class="count-value" id="countA">0</span><span class="count-prob" id="probA">0.000%</span></div>
                    <div class="count-row"><span class="count-label">2:</span><span class="count-value" id="count2">0</span><span class="count-prob" id="prob2">0.000%</span></div>
                    <div class="count-row"><span class="count-label">3:</span><span class="count-value" id="count3">0</span><span class="count-prob" id="prob3">0.000%</span></div>
                    <div class="count-row"><span class="count-label">4:</span><span class="count-value" id="count4">0</span><span class="count-prob" id="prob4">0.000%</span></div>
                    <div class="count-row"><span class="count-label">5:</span><span class="count-value" id="count5">0</span><span class="count-prob" id="prob5">0.000%</span></div>
                    <div class="count-row"><span class="count-label">6:</span><span class="count-value" id="count6">0</span><span class="count-prob" id="prob6">0.000%</span></div>
                    <div class="count-row"><span class="count-label">7:</span><span class="count-value" id="count7">0</span><span class="count-prob" id="prob7">0.000%</span></div>
                    <div class="count-row"><span class="count-label">8:</span><span class="count-value" id="count8">0</span><span class="count-prob" id="prob8">0.000%</span></div>
                    <div class="count-row"><span class="count-label">9:</span><span class="count-value" id="count9">0</span><span class="count-prob" id="prob9">0.000%</span></div>
                    <div class="count-row"><span class="count-label">10:</span><span class="count-value" id="count10">0</span><span class="count-prob" id="prob10">0.000%</span></div>
                    <div class="count-row"><span class="count-label">J:</span><span class="count-value" id="countJ">0</span><span class="count-prob" id="probJ">0.000%</span></div>
                    <div class="count-row"><span class="count-label">Q:</span><span class="count-value" id="countQ">0</span><span class="count-prob" id="probQ">0.000%</span></div>
                    <div class="count-row"><span class="count-label">K:</span><span class="count-value" id="countK">0</span><span class="count-prob" id="probK">0.000%</span></div>
                    <div class="count-row"><span class="count-label">Œ£10:</span><span class="count-value" id="count10val">0</span><span class="count-prob" id="prob10val">0.000%</span></div>
                </div>
                <div class="shoe-info">
                    <strong>Total Cards Dealt:</strong> <span id="totalDealt">0</span><br>
                    <strong>Cards Remaining:</strong> <span id="cardsRemaining">312</span>
                </div>
            </div>

            <div id="handHistoryPanel" class="history-panel hidden">
                <div id="handHistoryList" class="history-list">
                    <div class="no-history">No hands played yet</div>
                </div>
            </div>

            <button id="btnCloseHistory" class="full-btn close-btn">Close</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal">
            <h2>Game Settings</h2>
            <div class="setting-row"><label>Decks</label><input type="number" id="cfgDecks" value="6" min="0.5" max="8" step="any"></div>
            <div class="setting-row"><label>Target Score</label><input type="number" id="cfgTarget" value="21" min="10" max="50"></div>
            <div class="setting-row"><label>Dealer Stands</label><input type="number" id="cfgDealerStand" value="17" min="10" max="25"></div>
            <div class="setting-row"><label>Reshuffle at % Remaining</label><input type="number" id="cfgReshuffle" value="20" min="5" max="50" step="5"></div>
            <div class="button-row">
                <button id="btnResetDeck" class="half-btn">üîÑ Reset Deck</button>
                <button id="btnReshuffle" class="half-btn">üîÄ Re-shuffle</button>
            </div>
            <button id="btnResetFunds" class="full-btn reset-funds">Reset Funds ($1000)</button>
            <button id="btnResetRules" class="full-btn reset-rules">Restore Default Rules</button>
            <button id="btnCloseSettings" class="full-btn close-btn">Save & Close</button>
            <button id="btnCancelSettings" class="full-btn">Cancel</button>
        </div>
    </div>

    <div id="debugOverlay" class="debug-overlay hidden">
        <div class="debug-panel">
            <h2>‚ö†Ô∏è Debug Console</h2>
            <p>Force specific game states for testing</p>
            <div class="debug-commands">
                <button class="debug-btn" id="debugPlayerBJ">üÉè Force Player Blackjack</button>
                <button class="debug-btn" id="debugPlayerBust">üí• Force Player Bust (Next Hit)</button>
                <button class="debug-btn" id="debugDealerBust">üíÄ Force Dealer Bust</button>
                <button class="debug-btn" id="debugTie">ü§ù Force Tie (Match Scores)</button>
                <button class="debug-btn" id="debugReshuffle">üîÑ Force Reshuffle Shoe</button>
                <button class="debug-btn danger" id="debugResetBank">üí∞ Reset Bank to $1000</button>
            </div>
            <button class="debug-close" id="debugClose">Close Debug Console</button>
        </div>
    </div>

    <div id="insuranceModal" class="modal-overlay hidden">
        <div class="modal insurance-modal">
            <h2>üõ°Ô∏è Insurance?</h2>
            <p>Dealer shows an Ace. Would you like to buy insurance?</p>
            <p class="insurance-info">Cost: <span id="insuranceCost">$0</span> (Half your bet)<br>
            Pays 2:1 if dealer has Blackjack</p>
            <div class="insurance-actions">
                <button id="btnInsuranceYes" class="action-btn primary">YES</button>
                <button id="btnInsuranceNo" class="action-btn">NO</button>
            </div>
        </div>
    </div>

    <div id="rulesModal" class="modal-overlay hidden">
        <div class="modal rules-modal">
            <h2>üìñ How to Play Blackjack</h2>
            <div class="rules-content">
                <h3>Objective</h3>
                <p>Beat the dealer by getting a hand value closer to <strong id="rulesTarget">21</strong> without going over (busting).</p>

                <h3>Card Values</h3>
                <ul>
                    <li><strong>Number cards (2-10):</strong> Face value</li>
                    <li><strong>Face cards (J, Q, K):</strong> 10 points</li>
                    <li><strong>Ace:</strong> 1 or 11 (whichever benefits you)</li>
                </ul>

                <h3>Gameplay</h3>
                <ol>
                    <li><strong>Place your bet</strong> using the chips</li>
                    <li><strong>Deal:</strong> You and dealer each get 2 cards (one dealer card face-down)</li>
                    <li><strong>Your turn:</strong> Hit (take card) or Stand (keep hand)</li>
                    <li><strong>Dealer's turn:</strong> Dealer reveals hole card and must hit until reaching <strong id="rulesDealerStand">17</strong></li>
                </ol>

                <h3>Winning</h3>
                <ul>
                    <li><strong>Blackjack:</strong> Ace + 10-value card on first 2 cards (pays 3:2)</li>
                    <li><strong>Win:</strong> Higher hand than dealer without busting (pays 1:1)</li>
                    <li><strong>Push:</strong> Same value as dealer (bet returned)</li>
                    <li><strong>Lose:</strong> Bust or lower than dealer</li>
                </ul>

                <h3>Special Actions</h3>
                <ul>
                    <li><strong>Double Down:</strong> Double your bet, receive exactly one more card</li>
                    <li><strong>Insurance:</strong> When dealer shows Ace, bet half your wager against dealer blackjack (pays 2:1)</li>
                </ul>

                <h3 class="rules-settings-header">Current Settings</h3>
                <ul class="rules-settings">
                    <li>Decks in shoe: <strong id="rulesDecks">6</strong></li>
                    <li>Target score: <strong id="rulesTargetSetting">21</strong></li>
                    <li>Dealer stands on: <strong id="rulesDealerStandSetting">17</strong></li>
                    <li>Reshuffle at: <strong id="rulesReshuffle">20</strong>% remaining</li>
                </ul>
            </div>
            <button id="btnCloseRules" class="full-btn close-btn">Close</button>
        </div>
    </div>

    <script src="../shared/enums.js"></script>
    <script src="../shared/card-assets.js"></script>
    <script src="../shared/card.js"></script>
    <script src="../shared/deck.js"></script>
    <script src="../shared/pile.js"></script>
    <script src="../shared/player.js"></script>
    <script src="../shared/engine.js"></script>
    <script src="ruleset.js"></script>

    <script>
        // Simple sound system using Web Audio API
        const GameSounds = {
            ctx: null,
            enabled: true,

            init() {
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('[Sound] Web Audio not supported');
                    this.enabled = false;
                }
            },

            _playTone(freq, duration, type = 'sine', volume = 0.3) {
                if (!this.enabled || !this.ctx) return;
                // Resume context if suspended (mobile requirement)
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.value = volume;
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            win() {
                // Happy ascending arpeggio
                this._playTone(523, 0.15, 'sine', 0.25); // C5
                setTimeout(() => this._playTone(659, 0.15, 'sine', 0.25), 100); // E5
                setTimeout(() => this._playTone(784, 0.2, 'sine', 0.3), 200); // G5
                setTimeout(() => this._playTone(1047, 0.3, 'sine', 0.35), 300); // C6
            },

            blackjack() {
                // Extra celebratory fanfare
                this._playTone(523, 0.1, 'sine', 0.25);
                setTimeout(() => this._playTone(659, 0.1, 'sine', 0.25), 80);
                setTimeout(() => this._playTone(784, 0.1, 'sine', 0.3), 160);
                setTimeout(() => this._playTone(1047, 0.15, 'sine', 0.35), 240);
                setTimeout(() => this._playTone(1319, 0.3, 'sine', 0.4), 320); // E6
            },

            lose() {
                // Sad descending tone
                this._playTone(392, 0.2, 'triangle', 0.25); // G4
                setTimeout(() => this._playTone(330, 0.2, 'triangle', 0.2), 150); // E4
                setTimeout(() => this._playTone(262, 0.3, 'triangle', 0.15), 300); // C4
            },

            push() {
                // Neutral double tone
                this._playTone(440, 0.15, 'sine', 0.2); // A4
                setTimeout(() => this._playTone(440, 0.2, 'sine', 0.2), 200);
            },

            flip() {
                // Quick card flip sound
                this._playTone(800, 0.05, 'square', 0.1);
            },

            chip() {
                // Chip click
                this._playTone(1200, 0.03, 'square', 0.15);
            }
        };

        class BlackjackUI {
            constructor() {
                CardAssets.init();
                GameSounds.init();
                // DEBUG ON to help identify states if needed
                this.engine = new GameEngine(BlackjackRuleset, { debug: true });
                this.wager = 25;
                this.holeCardHidden = true;
                this.reshuffleThreshold = 20; // Default 20% of cards remaining

                // History tracking
                this.cardCounts = this._initCardCounts();
                this.handHistory = [];
                this.handNumber = 0;
                this.totalCardsDealt = 0;

                this.el = {
                    balance: document.getElementById('balance'),
                    dealerCards: document.getElementById('dealerCards'),
                    playerCards: document.getElementById('playerCards'),
                    dealerValue: document.getElementById('dealerValue'),
                    playerValue: document.getElementById('playerValue'),
                    message: document.getElementById('message'),
                    betDisplay: document.getElementById('currentBetDisplay'),
                    bettingRow: document.getElementById('bettingRow'),
                    actionRow: document.getElementById('actionRow'),
                    gameOverRow: document.getElementById('gameOverRow'),
                    btnDeal: document.getElementById('btnDeal'),
                    btnResetDeckBetting: document.getElementById('btnResetDeckBetting'),
                    btnHit: document.getElementById('btnHit'),
                    btnStand: document.getElementById('btnStand'),
                    btnDouble: document.getElementById('btnDouble'),
                    btnNew: document.getElementById('btnNew'),
                    btnPlayAgain: document.getElementById('btnPlayAgain'),
                    lastBetAmount: document.getElementById('lastBetAmount'),
                    btnClearBet: document.getElementById('btnClearBet'),
                    settingsModal: document.getElementById('settingsModal'),
                    btnSettings: document.getElementById('btnSettings'),
                    btnCloseSettings: document.getElementById('btnCloseSettings'),
                    btnCancelSettings: document.getElementById('btnCancelSettings'),
                    btnResetDeck: document.getElementById('btnResetDeck'),
                    btnReshuffle: document.getElementById('btnReshuffle'),
                    btnResetFunds: document.getElementById('btnResetFunds'),
                    btnResetRules: document.getElementById('btnResetRules'),
                    cfgDecks: document.getElementById('cfgDecks'),
                    cfgTarget: document.getElementById('cfgTarget'),
                    cfgDealerStand: document.getElementById('cfgDealerStand'),
                    cfgReshuffle: document.getElementById('cfgReshuffle'),
                    debugOverlay: document.getElementById('debugOverlay'),
                    debugClose: document.getElementById('debugClose'),
                    debugPlayerBJ: document.getElementById('debugPlayerBJ'),
                    debugPlayerBust: document.getElementById('debugPlayerBust'),
                    debugDealerBust: document.getElementById('debugDealerBust'),
                    debugTie: document.getElementById('debugTie'),
                    debugReshuffle: document.getElementById('debugReshuffle'),
                    debugResetBank: document.getElementById('debugResetBank'),
                    header: document.querySelector('.header'),
                    insuranceModal: document.getElementById('insuranceModal'),
                    insuranceCost: document.getElementById('insuranceCost'),
                    btnInsuranceYes: document.getElementById('btnInsuranceYes'),
                    btnInsuranceNo: document.getElementById('btnInsuranceNo'),
                    historyModal: document.getElementById('historyModal'),
                    btnHistory: document.getElementById('btnHistory'),
                    btnCloseHistory: document.getElementById('btnCloseHistory'),
                    rulesModal: document.getElementById('rulesModal'),
                    btnRules: document.getElementById('btnRules'),
                    btnCloseRules: document.getElementById('btnCloseRules'),
                    tabCardCount: document.getElementById('tabCardCount'),
                    tabHandHistory: document.getElementById('tabHandHistory'),
                    cardCountPanel: document.getElementById('cardCountPanel'),
                    handHistoryPanel: document.getElementById('handHistoryPanel'),
                    handHistoryList: document.getElementById('handHistoryList'),
                    totalDealt: document.getElementById('totalDealt'),
                    cardsRemaining: document.getElementById('cardsRemaining')
                };

                // Insurance tracking
                this.insuranceBet = 0;
                this.insuranceOffered = false;

                // Triple-tap counter for debug console
                this.tapCount = 0;
                this.tapTimer = null;

                this._bindEvents();
                this._subscribeToEngine();
                this._loadSettings();
                this._initGame();
            }

            _bindEvents() {
                // History Modal
                this.el.btnHistory.onclick = () => {
                    this._updateHistoryDisplay();
                    this.el.historyModal.classList.remove('hidden');
                };
                this.el.btnCloseHistory.onclick = () => this.el.historyModal.classList.add('hidden');

                // Rules modal
                this.el.btnRules.onclick = () => {
                    this._updateRulesDisplay();
                    this.el.rulesModal.classList.remove('hidden');
                };
                this.el.btnCloseRules.onclick = () => this.el.rulesModal.classList.add('hidden');
                this.el.rulesModal.onclick = (e) => {
                    if (e.target === this.el.rulesModal) {
                        this.el.rulesModal.classList.add('hidden');
                    }
                };
                this.el.tabCardCount.onclick = () => this._showHistoryTab('cardCount');
                this.el.tabHandHistory.onclick = () => this._showHistoryTab('handHistory');

                // Click outside history modal to close
                this.el.historyModal.onclick = (e) => {
                    if (e.target === this.el.historyModal) {
                        this.el.historyModal.classList.add('hidden');
                    }
                };

                // Settings Modal
                this.el.btnSettings.onclick = () => {
                    this._loadSettings();
                    this.el.settingsModal.classList.remove('hidden');
                };
                this.el.btnCloseSettings.onclick = () => this._saveSettings();
                this.el.btnCancelSettings.onclick = () => {
                    this._loadSettings(); // Restore original values
                    this.el.settingsModal.classList.add('hidden');
                };
                this.el.btnResetDeck.onclick = () => this._resetDeck();
                this.el.btnReshuffle.onclick = () => this._reshuffle();
                this.el.btnResetFunds.onclick = () => this._resetFunds();
                this.el.btnResetRules.onclick = () => this._resetRules();

                // Click outside settings modal to close
                this.el.settingsModal.onclick = (e) => {
                    if (e.target === this.el.settingsModal) {
                        this._loadSettings(); // Restore original values
                        this.el.settingsModal.classList.add('hidden');
                    }
                };

                document.querySelectorAll('.chip:not(#btnClearBet)').forEach(btn => {
                    btn.onclick = () => {
                        GameSounds.chip();
                        this.wager += parseInt(btn.dataset.val);
                        this._updateBetDisplay();
                    };
                });
                this.el.btnClearBet.onclick = () => {
                    GameSounds.chip();
                    this.wager = 0;
                    this._updateBetDisplay();
                };

                this.el.btnDeal.onclick = () => this.deal();
                this.el.btnResetDeckBetting.onclick = () => this._resetDeck();
                this.el.btnHit.onclick = () => this.engine.submitAction('player1', 'hit');
                this.el.btnStand.onclick = () => this.engine.submitAction('player1', 'stand');
                this.el.btnDouble.onclick = () => this.engine.submitAction('player1', 'double');
                this.el.btnPlayAgain.onclick = () => this.playAgain();
                this.el.btnNew.onclick = () => this.newHand();

                // Debug Console: Triple-tap on header to reveal
                this.el.header.onclick = () => {
                    this.tapCount++;
                    clearTimeout(this.tapTimer);
                    if (this.tapCount === 3) {
                        this.el.debugOverlay.classList.remove('hidden');
                        this.tapCount = 0;
                    } else {
                        this.tapTimer = setTimeout(() => { this.tapCount = 0; }, 500);
                    }
                };

                // Debug Command Handlers
                this.el.debugClose.onclick = () => this.el.debugOverlay.classList.add('hidden');
                this.el.debugPlayerBJ.onclick = () => this._debugForcePlayerBlackjack();
                this.el.debugPlayerBust.onclick = () => this._debugForcePlayerBust();
                this.el.debugDealerBust.onclick = () => this._debugForceDealerBust();
                this.el.debugTie.onclick = () => this._debugForceTie();
                this.el.debugReshuffle.onclick = () => this._resetDeck();
                this.el.debugResetBank.onclick = () => this._debugResetBank();

                // Insurance Handlers
                this.el.btnInsuranceYes.onclick = () => this._acceptInsurance();
                this.el.btnInsuranceNo.onclick = () => this._declineInsurance();
            }

            _subscribeToEngine() {
                this.engine.on('*', (event) => {
                    switch (event.type) {
                        case 'DEAL':
                            this._handleDealEvent(event);
                            this._trackCard(event.card);
                            break;
                        case 'TURN_START': this._handleTurnStart(event); break;
                        case 'REVEAL': this._handleReveal(); break;
                        case 'RESOLUTION': this._handleResolution(event); break;
                        case 'GAME_OVER': this._handleGameOver(); break;
                        case 'PAYOUT': this._updateBalance(); break;
                    }
                });
            }

            _initGame() {
                const storedBalance = parseInt(localStorage.getItem('family_arcade_balance')) || 1000;
                this.engine.init([{ id: 'player1', type: 'human', name: 'You', balance: storedBalance }]);
                this._updateBalance();
                this._updateBetDisplay();
                this._resetTableVisuals();
            }

            _loadSettings() {
                const savedJson = localStorage.getItem('blackjack_config');
                if (savedJson) {
                    try {
                        const saved = JSON.parse(savedJson);
                        BlackjackRuleset.deckCount = saved.deckCount;
                        BlackjackRuleset.targetScore = saved.targetScore;
                        BlackjackRuleset.dealerStandThreshold = saved.dealerStandThreshold;
                        if (saved.reshuffleThreshold !== undefined) {
                            this.reshuffleThreshold = saved.reshuffleThreshold;
                        }
                    } catch(e) {}
                }
                this.el.cfgDecks.value = BlackjackRuleset.deckCount;
                this.el.cfgTarget.value = BlackjackRuleset.targetScore;
                this.el.cfgDealerStand.value = BlackjackRuleset.dealerStandThreshold;
                this.el.cfgReshuffle.value = this.reshuffleThreshold;
            }

            _saveSettings() {
                // Validate and parse deck count (supports decimals like 6.5)
                var deckValue = parseFloat(this.el.cfgDecks.value);
                if (isNaN(deckValue) || deckValue <= 0) {
                    deckValue = 1; // Default to 1 if invalid
                }
                // Round to nearest 0.5 for clean values
                deckValue = Math.round(deckValue * 2) / 2;
                BlackjackRuleset.deckCount = deckValue;

                BlackjackRuleset.targetScore = parseInt(this.el.cfgTarget.value) || 21;
                BlackjackRuleset.dealerStandThreshold = parseInt(this.el.cfgDealerStand.value) || 17;
                this.reshuffleThreshold = parseInt(this.el.cfgReshuffle.value) || 20;
                localStorage.setItem('blackjack_config', JSON.stringify({
                    deckCount: BlackjackRuleset.deckCount,
                    targetScore: BlackjackRuleset.targetScore,
                    dealerStandThreshold: BlackjackRuleset.dealerStandThreshold,
                    reshuffleThreshold: this.reshuffleThreshold
                }));
                this.el.settingsModal.classList.add('hidden');
            }

            _resetRules() {
                if(confirm("Restore default rules?")) {
                    this.el.cfgDecks.value = 6;
                    this.el.cfgTarget.value = 21;
                    this.el.cfgDealerStand.value = 17;
                    this.el.cfgReshuffle.value = 20;
                    this._saveSettings();
                }
            }

            _resetFunds() {
                if(confirm("Reset funds to $1000?")) {
                    localStorage.setItem('family_arcade_balance', 1000);
                    const player = this.engine.players[0];
                    player.balance = 1000;
                    this._updateBalance();
                    this.el.settingsModal.classList.add('hidden');
                }
            }

            _updateBetDisplay() {
                this.el.betDisplay.textContent = this.wager;
            }

            deal() {
                const player = this.engine.players[0];
                if (this.wager === 0) {
                    this._showMessage('Place a bet!', 'push');
                    return;
                }
                if (this.wager > player.balance) {
                    this._showMessage('Not enough chips!', 'lose');
                    return;
                }

                // Check if we need to reshuffle before dealing
                this._checkAndReshuffle();

                this._resetTableVisuals();
                this._showControls('none');

                this.engine.startRound();
                this.engine.placeBet('player1', this.wager);
                this.engine.confirmBets();
            }

            _checkAndReshuffle() {
                const totalCards = BlackjackRuleset.deckCount * 52;
                const remaining = totalCards - this.totalCardsDealt;
                const percentRemaining = (remaining / totalCards) * 100;

                if (percentRemaining < this.reshuffleThreshold) {
                    console.log(`[Reshuffle] Triggered at ${percentRemaining.toFixed(1)}% remaining (threshold: ${this.reshuffleThreshold}%)`);

                    // Rebuild the shoe (destroy and recreate)
                    this.engine.piles.shoe = Pile.createFrom(StandardDeck, BlackjackRuleset.deckCount);
                    this.engine.piles.shoe.shuffle();

                    // Reset card tracking
                    this.totalCardsDealt = 0;
                    this.cardCounts = {
                        'A': 0, '2': 0, '3': 0, '4': 0, '5': 0, '6': 0,
                        '7': 0, '8': 0, '9': 0, '10': 0, 'J': 0, 'Q': 0, 'K': 0
                    };

                    // Show toast message
                    this._showMessage('üîÑ Shuffling shoe...', 'info');

                    // Update history display to show reset counts
                    this._updateHistoryDisplay();
                }
            }

            _resetTableVisuals() {
                this.holeCardHidden = true;
                this.insuranceBet = 0;
                this.insuranceOffered = false;
                this.el.dealerCards.innerHTML = '<div class="card-slot placeholder"></div><div class="card-slot placeholder"></div>';
                this.el.playerCards.innerHTML = '<div class="card-slot placeholder"></div><div class="card-slot placeholder"></div>';
                this.el.dealerValue.textContent = '-';
                this.el.playerValue.textContent = '-';
                this.el.playerValue.className = 'hand-value';
                this.el.dealerValue.className = 'hand-value';
                this._showMessage('');
            }

            playAgain() {
                // Deal with same bet as last hand (wager is already set)
                this.engine.players[0]._hasStood = false;
                if (this.engine.dealer) {
                    this.engine.dealer._hasStood = false;
                }
                this._resetTableVisuals();
                this.deal();
            }

            newHand() {
                this.engine.players[0]._hasStood = false;
                if (this.engine.dealer) {
                    this.engine.dealer._hasStood = false;
                }
                this._showControls('betting');
                this._showMessage('Place your bet!');
            }

            _handleDealEvent(event) {
                const container = event.to.id === 'dealer' ? this.el.dealerCards : this.el.playerCards;
                const faceUp = event.faceUp;
                const placeholder = container.querySelector('.placeholder');
                if(placeholder) placeholder.remove();
                this._flyCard(event.card, container, faceUp);
            }

            _flyCard(cardData, container, faceUp) {
                // Create invisible placeholder to calculate destination coordinates
                // Use visibility:hidden instead of opacity:0 to ensure no flash
                var tempSlot = document.createElement('div');
                tempSlot.className = 'card-slot';
                tempSlot.style.visibility = 'hidden';
                tempSlot.style.pointerEvents = 'none';
                container.appendChild(tempSlot);

                var endRect = tempSlot.getBoundingClientRect();
                var startX = window.innerWidth - 50;
                var startY = -100;

                // Create flying card at shoe position (off-screen top-right)
                GameSounds.flip();
                var flyer = this._createCardElement(cardData, faceUp);
                flyer.style.position = 'fixed';
                flyer.style.left = startX + 'px';
                flyer.style.top = startY + 'px';
                flyer.style.width = '86px';
                flyer.style.height = '120px';
                flyer.style.zIndex = '1000';
                flyer.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                flyer.style.pointerEvents = 'none';
                document.body.appendChild(flyer);

                // Capture references for setTimeout closure
                var self = this;

                // Start animation on next frame (ensures initial position is rendered first)
                requestAnimationFrame(function() {
                    flyer.style.left = endRect.left + 'px';
                    flyer.style.top = endRect.top + 'px';
                    flyer.style.transform = 'rotate(' + ((Math.random() * 6) - 3) + 'deg)';
                });

                // After animation completes, replace temp with real card
                setTimeout(function() {
                    flyer.remove();
                    tempSlot.remove();

                    // NOW add the actual card (no preview flash)
                    var landingPad = self._createCardElement(cardData, faceUp);
                    container.appendChild(landingPad);
                    self._updateValues();
                }, 500);
            }

            _createCardElement(cardData, faceUp) {
                const slot = document.createElement('div');
                slot.className = 'card-slot';
                if (!faceUp) {
                    slot.classList.add('face-down');
                }
                slot.dataset.uuid = cardData.uuid;
                let canvas;
                if (faceUp) {
                    const rankKey = RankToAsset[cardData.rank];
                    const suitKey = SuitToAsset[cardData.suit];
                    canvas = CardAssets.getAsset(rankKey, suitKey);
                } else {
                    canvas = CardAssets.getAsset();
                }
                const clone = document.createElement('canvas');
                clone.width = canvas.width;
                clone.height = canvas.height;
                clone.getContext('2d').drawImage(canvas, 0, 0);
                slot.appendChild(clone);
                return slot;
            }

            _handleTurnStart(event) {
                if (event.actorId === 'player1') {
                    // Check for insurance offer BEFORE showing controls
                    const gameState = this.engine.getGameState();
                    if (!this.insuranceOffered && BlackjackRuleset.shouldOfferInsurance(gameState)) {
                        this._offerInsurance();
                        return; // Wait for insurance decision before showing controls
                    }

                    this._showControls('action');
                    this._showMessage('Your turn');
                    this._disableActionButtons(false);
                    const canDouble = event.availableActions && event.availableActions.includes('double');
                    this.el.btnDouble.disabled = !canDouble;
                } else if (event.actorId === 'dealer') {
                    this._showControls('none');
                    this._showMessage("Dealer's turn...");

                    // Track hole card before revealing it
                    // Hole card is FIRST card (index 0) in shoe dealing
                    if (this.holeCardHidden) {
                        const dealer = this.engine.dealer;
                        if (dealer && dealer.hand.count >= 1) {
                            const holeCard = dealer.hand.contents[0];
                            console.log('[TurnStart] Tracking dealer hole card before reveal:', holeCard.rank);
                            // Set flag false FIRST so _trackCard won't skip it
                            this.holeCardHidden = false;
                            this._trackCard(holeCard.toJSON ? holeCard.toJSON() : holeCard);
                        } else {
                            this.holeCardHidden = false;
                        }
                    }

                    this._redrawDealer();
                }
            }

            _handleReveal() {
                // Count hole card now that it's revealed
                // Hole card is FIRST card (index 0) in shoe dealing
                // MUST set flag to false BEFORE tracking, otherwise _trackCard will skip it
                this.holeCardHidden = false;

                const dealer = this.engine.dealer;
                if (dealer && dealer.hand.count >= 1) {
                    const holeCard = dealer.hand.contents[0];
                    const cardData = holeCard.toJSON ? holeCard.toJSON() : holeCard;
                    this._trackCard(cardData);
                }

                this._redrawDealer();
            }

            _handleResolution(event) {
                const result = event.playerResults[0];
                let msg = '', cls = '';
                const target = BlackjackRuleset.targetScore;

                // CRITICAL: Reveal dealer's hole card at resolution
                // Track hole card if it wasn't already counted
                // Hole card is FIRST card (index 0) in shoe dealing
                if (this.holeCardHidden) {
                    console.log('[Resolution] Hole card is still hidden, revealing and tracking...');
                    // MUST set flag to false BEFORE tracking, otherwise _trackCard will skip it
                    this.holeCardHidden = false;

                    const dealer = this.engine.dealer;
                    if (dealer && dealer.hand.count >= 1) {
                        const holeCard = dealer.hand.contents[0];
                        console.log('[Resolution] Tracking hole card:', holeCard);
                        this._trackCard(holeCard.toJSON ? holeCard.toJSON() : holeCard);
                    }
                } else {
                    console.log('[Resolution] Hole card was already revealed (holeCardHidden was false)');
                    this.holeCardHidden = false;
                }

                this._redrawDealer();
                this._updateValues();

                // Check for insurance (already paid in _acceptInsurance if dealer had BJ, just show message)
                if (this.insuranceBet > 0) {
                    const dealer = this.engine.dealer;
                    const dealerValue = BlackjackRuleset.evaluateHand(dealer.hand.contents);

                    if (dealerValue.isBlackjack) {
                        // Insurance was already paid in _acceptInsurance, just show message
                        console.log(`[Insurance] Insurance already paid when dealer revealed Blackjack`);
                        msg = 'Insurance Paid! ';
                    } else {
                        console.log(`[Insurance] Dealer does not have Blackjack. Insurance lost.`);
                    }
                }

                if (result.outcome === 'blackjack') { msg += 'BLACKJACK!'; cls = 'blackjack'; GameSounds.blackjack(); }
                else if (result.outcome === 'win') { msg += 'You Win!'; cls = 'win'; GameSounds.win(); }
                else if (result.outcome === 'push') { msg += 'Push'; cls = 'push'; GameSounds.push(); }
                else { msg += result.playerValue > target ? 'Bust!' : 'Dealer Wins'; cls = 'lose'; GameSounds.lose(); }
                this._showMessage(msg, cls);

                // Log hand to history
                this._logHandResult(result);
            }

            _handleGameOver() {
                // CRITICAL: Reveal dealer's hole card if still hidden
                if (this.holeCardHidden) {
                    this.holeCardHidden = false;
                    this._redrawDealer();
                }

                // Update final values
                this._updateValues();

                // Update "Play Again" button with last bet amount
                this.el.lastBetAmount.textContent = '$' + this.wager;

                // FORCE controls visible even if logic tried to hide them
                this._showControls('gameover');
                this._updateBalance();
                localStorage.setItem('family_arcade_balance', this.engine.players[0].balance);
            }

            _redrawDealer() {
                const dealer = this.engine.dealer;
                if (!dealer) return;
                this.el.dealerCards.innerHTML = '';
                dealer.hand.contents.forEach((card, i) => {
                    // First card (index 0) is hole card, face-down unless revealed
                    // Second card (index 1) and beyond are always face-up
                    const faceUp = i !== 0 || !this.holeCardHidden;
                    const slot = this._createCardElement(card, faceUp);
                    this.el.dealerCards.appendChild(slot);
                });
                this._updateValues();
            }

            _updateValues() {
                const target = BlackjackRuleset.targetScore;
                const player = this.engine.players[0];

                // Player value bubble logic
                if (player && player.hand.count > 0) {
                    const pv = BlackjackRuleset.evaluateHand(player.hand.contents);
                    this.el.playerValue.textContent = pv.best;
                    let cls = 'hand-value';

                    // BUBBLE LOGIC: Hide if value is 0
                    if (pv.best === 0) {
                        cls += ' hidden-value';
                    }

                    if (pv.best > target) {
                        cls += ' bust';
                        this._disableActionButtons(true); // Disable if bust
                    } else if (pv.isBlackjack) {
                        cls += ' blackjack';
                    } else if (pv.best === target) {
                        cls += ' max';
                        this.el.btnHit.disabled = true; // Disable hit on 21
                        this.el.btnDouble.disabled = true;
                    }

                    // FIX: Double Down only available on first move (2 cards)
                    if (player.hand.count > 2) {
                        this.el.btnDouble.disabled = true;
                    }
                    this.el.playerValue.className = cls;
                } else {
                    // BUBBLE LOGIC: Hide if no cards
                    this.el.playerValue.className = 'hand-value hidden-value';
                    this.el.playerValue.textContent = '-';
                }

                const dealer = this.engine.dealer;
                // Dealer value bubble logic
                if (dealer && dealer.hand.count > 0) {
                    if (this.holeCardHidden && dealer.hand.count >= 2) {
                        // Show UP card value (second card, index 1) while hole card is hidden
                        const v = BlackjackRuleset._getCardValue(dealer.hand.contents[1]);
                        this.el.dealerValue.textContent = v === 11 ? 'A' : v;
                        this.el.dealerValue.className = 'hand-value';
                    } else {
                        const dv = BlackjackRuleset.evaluateHand(dealer.hand.contents);
                        this.el.dealerValue.textContent = dv.best;
                        let cls = 'hand-value';

                        // BUBBLE LOGIC: Hide if value is 0
                        if (dv.best === 0) {
                            cls += ' hidden-value';
                        }

                        if (dv.best > target) {
                            cls += ' bust';
                        }
                        this.el.dealerValue.className = cls;
                    }
                } else {
                    // BUBBLE LOGIC: Hide if no cards
                    this.el.dealerValue.className = 'hand-value hidden-value';
                    this.el.dealerValue.textContent = '-';
                }
            }

            _disableActionButtons(disabled) {
                this.el.btnHit.disabled = disabled;
                this.el.btnStand.disabled = disabled;
                this.el.btnDouble.disabled = disabled;
            }

            _updateBalance() {
                const player = this.engine.players[0];
                if (player) this.el.balance.textContent = player.balance;
            }

            _showControls(phase) {
                ['bettingRow', 'actionRow', 'gameOverRow'].forEach(id => this.el[id].classList.add('hidden'));
                if (phase === 'betting') this.el.bettingRow.classList.remove('hidden');
                if (phase === 'action') this.el.actionRow.classList.remove('hidden');
                if (phase === 'gameover') this.el.gameOverRow.classList.remove('hidden');
            }
            
            _showMessage(text, className = '') {
                this.el.message.textContent = text;
                this.el.message.className = 'message visible ' + className;
                // Auto-fade logic could go here, but stickiness is better for game over
            }

            // ================================================================
            // INSURANCE LOGIC
            // ================================================================

            _offerInsurance() {
                const player = this.engine.players[0];
                const halfBet = Math.floor(this.wager / 2);

                // Check if player has enough balance
                if (halfBet > player.balance) {
                    this.insuranceOffered = true;
                    // Not enough funds, skip insurance
                    this._showControls('action');
                    this._showMessage('Your turn');
                    this._disableActionButtons(false);
                    return;
                }

                this.el.insuranceCost.textContent = `$${halfBet}`;
                this.el.insuranceModal.classList.remove('hidden');
            }

            _acceptInsurance() {
                const player = this.engine.players[0];
                const halfBet = Math.floor(this.wager / 2);

                // Deduct insurance bet
                player.balance -= halfBet;
                this.insuranceBet = halfBet;
                this.insuranceOffered = true;

                this._updateBalance();
                this.el.insuranceModal.classList.add('hidden');

                console.log(`[Insurance] Player bought insurance for $${halfBet}`);

                // CRITICAL: Check for dealer blackjack immediately
                const dealer = this.engine.dealer;
                const dealerValue = BlackjackRuleset.evaluateHand(dealer.hand.contents);

                if (dealerValue.isBlackjack) {
                    // Dealer has blackjack - reveal hole card and end round immediately
                    console.log('[Insurance] Dealer has Blackjack! Revealing and resolving...');
                    this.holeCardHidden = false;
                    this._redrawDealer();

                    // Insurance pays 2:1
                    const insurancePayout = BlackjackRuleset.calculateInsurancePayout(this.insuranceBet);
                    player.balance += insurancePayout;
                    console.log(`[Insurance] Insurance paid $${insurancePayout}`);

                    // Force transition to resolution (dealer blackjack ends the round)
                    this.engine.transitionTo(GameState.RESOLUTION);
                } else {
                    // Dealer doesn't have blackjack - continue with player's turn
                    console.log('[Insurance] Dealer does not have Blackjack. Continuing play...');
                    this._showControls('action');
                    this._showMessage('Your turn (Insurance Active)');
                    this._disableActionButtons(false);
                    // FIX: Check available actions from ruleset, not just active actor
                    var availableActions = BlackjackRuleset.getAvailableActions(this.engine.getGameState(), 'player1');
                    var canDouble = availableActions.includes('double');
                    this.el.btnDouble.disabled = !canDouble;
                }
            }

            _declineInsurance() {
                this.insuranceBet = 0;
                this.insuranceOffered = true;

                this.el.insuranceModal.classList.add('hidden');

                console.log('[Insurance] Player declined insurance');

                // CRITICAL: Check for dealer blackjack immediately
                const dealer = this.engine.dealer;
                const dealerValue = BlackjackRuleset.evaluateHand(dealer.hand.contents);

                if (dealerValue.isBlackjack) {
                    // Dealer has blackjack - reveal hole card and end round immediately
                    console.log('[Insurance] Dealer has Blackjack! Revealing and resolving...');
                    this.holeCardHidden = false;
                    this._redrawDealer();

                    // No insurance, so player loses bet (unless they also have blackjack)
                    // Force transition to resolution
                    this.engine.transitionTo(GameState.RESOLUTION);
                } else {
                    // Dealer doesn't have blackjack - continue with player's turn
                    console.log('[Insurance] Dealer does not have Blackjack. Continuing play...');
                    this._showControls('action');
                    this._showMessage('Your turn');
                    this._disableActionButtons(false);
                    // FIX: Check available actions from ruleset, not just active actor
                    var availableActions = BlackjackRuleset.getAvailableActions(this.engine.getGameState(), 'player1');
                    var canDouble = availableActions.includes('double');
                    this.el.btnDouble.disabled = !canDouble;
                }
            }

            // ================================================================
            // DEBUG COMMANDS
            // ================================================================

            _debugForcePlayerBlackjack() {
                const player = this.engine.players[0];
                if (!player) return alert('No active player');

                // Clear hand and give Ace + King
                player.hand.contents = [];
                player.hand.receive(new Card(Suit.SPADES, Rank.ACE, 'standard'), -1);
                player.hand.receive(new Card(Suit.HEARTS, Rank.KING, 'standard'), -1);

                this.el.playerCards.innerHTML = '';
                player.hand.contents.forEach(card => {
                    const slot = this._createCardElement(card, true);
                    this.el.playerCards.appendChild(slot);
                });

                this._updateValues();
                this.el.debugOverlay.classList.add('hidden');
                console.log('[DEBUG] Forced player blackjack');
            }

            _debugForcePlayerBust() {
                const player = this.engine.players[0];
                if (!player || player.hand.count === 0) return alert('Deal cards first');

                // Add a 10 to force bust (if current hand is close)
                const currentValue = BlackjackRuleset.evaluateHand(player.hand.contents).best;
                if (currentValue >= 12) {
                    // Add a 10 to bust
                    player.hand.receive(new Card(Suit.DIAMONDS, Rank.TEN, 'standard'), -1);

                    const slot = this._createCardElement(player.hand.contents[player.hand.count - 1], true);
                    this.el.playerCards.appendChild(slot);

                    this._updateValues();
                    this.el.debugOverlay.classList.add('hidden');
                    console.log('[DEBUG] Forced player bust');
                } else {
                    alert('Player needs at least 12 to bust with a 10');
                }
            }

            _debugForceDealerBust() {
                const dealer = this.engine.dealer;
                if (!dealer || dealer.hand.count === 0) return alert('Dealer needs cards first');

                // Keep adding cards until dealer busts
                const shoe = this.engine.piles.shoe;
                const target = BlackjackRuleset.targetScore;

                while (true) {
                    const val = BlackjackRuleset.evaluateHand(dealer.hand.contents);
                    if (val.best > target) break; // Already bust

                    const card = shoe.give(0);
                    if (!card) {
                        alert('Shoe is empty');
                        break;
                    }

                    dealer.hand.receive(card, -1);

                    const newVal = BlackjackRuleset.evaluateHand(dealer.hand.contents);
                    if (newVal.best > target) {
                        // Busted!
                        this.holeCardHidden = false;
                        this._redrawDealer();
                        this.el.debugOverlay.classList.add('hidden');
                        console.log('[DEBUG] Forced dealer bust');
                        break;
                    }

                    // Safety: prevent infinite loop
                    if (dealer.hand.count > 10) {
                        alert('Safety limit reached');
                        break;
                    }
                }
            }

            _debugForceTie() {
                const player = this.engine.players[0];
                const dealer = this.engine.dealer;
                if (!player || !dealer || player.hand.count === 0) return alert('Deal cards first');

                const playerValue = BlackjackRuleset.evaluateHand(player.hand.contents).best;

                // Clear dealer hand and build to match player
                dealer.hand.contents = [];

                // Simple approach: give dealer same value with different cards
                if (playerValue <= 11) {
                    // Use face card + small card
                    const needed = playerValue;
                    if (needed >= 2 && needed <= 11) {
                        dealer.hand.receive(new Card(Suit.CLUBS, Rank.KING, 'standard'), -1);
                        // Add second card to reach target
                        const ranks = [null, null, Rank.TWO, Rank.THREE, Rank.FOUR, Rank.FIVE,
                                      Rank.SIX, Rank.SEVEN, Rank.EIGHT, Rank.NINE, Rank.TEN, Rank.ACE];
                        const secondCard = ranks[needed];
                        if (secondCard) {
                            dealer.hand.receive(new Card(Suit.DIAMONDS, secondCard, 'standard'), -1);
                        }
                    }
                } else {
                    // Give two cards that sum to playerValue
                    const firstVal = Math.min(10, Math.floor(playerValue / 2));
                    const secondVal = playerValue - firstVal;

                    const rankMap = {2: Rank.TWO, 3: Rank.THREE, 4: Rank.FOUR, 5: Rank.FIVE,
                                    6: Rank.SIX, 7: Rank.SEVEN, 8: Rank.EIGHT, 9: Rank.NINE, 10: Rank.TEN};

                    dealer.hand.receive(new Card(Suit.CLUBS, rankMap[firstVal] || Rank.TEN, 'standard'), -1);
                    dealer.hand.receive(new Card(Suit.DIAMONDS, rankMap[secondVal] || Rank.TEN, 'standard'), -1);
                }

                this.holeCardHidden = false;
                this._redrawDealer();
                this.el.debugOverlay.classList.add('hidden');
                console.log(`[DEBUG] Forced tie at ${playerValue}`);
            }

            _resetDeck() {
                if (confirm('Reset Deck? This will create a new deck and reset card count history.')) {
                    // Reset the shoe (creates new deck from template)
                    this.engine.shoe.reset();
                    this.engine.shoe.shuffle();

                    // Reset card count history only (not hand history)
                    this.cardCounts = {
                        [Rank.ACE]: 0, [Rank.TWO]: 0, [Rank.THREE]: 0, [Rank.FOUR]: 0,
                        [Rank.FIVE]: 0, [Rank.SIX]: 0, [Rank.SEVEN]: 0, [Rank.EIGHT]: 0,
                        [Rank.NINE]: 0, [Rank.TEN]: 0, [Rank.JACK]: 0, [Rank.QUEEN]: 0, [Rank.KING]: 0
                    };

                    // Update the display
                    this._updateCardCountDisplay();
                    this._showMessage('üîÑ Deck reset!', 'push');
                    console.log('[SETTINGS] Deck reset - new deck created and card count cleared');
                }
            }

            _reshuffle() {
                if (confirm('Re-shuffle current cards? This will shuffle the remaining cards in the shoe without resetting card counts.')) {
                    // Shuffle current cards without resetting
                    this.engine.shoe.shuffle();
                    this._showMessage('üîÄ Shoe re-shuffled!', 'push');
                    console.log('[SETTINGS] Re-shuffle - current shoe shuffled without reset');
                }
            }


            _debugResetBank() {
                if (confirm('Reset bank to $1000?')) {
                    const player = this.engine.players[0];
                    if (player) {
                        player.balance = 1000;
                        localStorage.setItem('family_arcade_balance', 1000);
                        this._updateBalance();
                        this.el.debugOverlay.classList.add('hidden');
                        console.log('[DEBUG] Bank reset to $1000');
                    }
                }
            }

            // ================================================================
            // HISTORY TRACKING
            // ================================================================

            _initCardCounts() {
                const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
                const counts = {};
                ranks.forEach(rank => counts[rank] = 0);
                return counts;
            }

            _trackCard(cardData) {
                // Exclude dealer's hole card from count until revealed
                // Hole card is FIRST dealer card (index 0) in shoe dealing
                const dealer = this.engine.dealer;
                if (dealer && this.holeCardHidden) {
                    const dealerCards = dealer.hand.contents;
                    if (dealerCards.length >= 1 && dealerCards[0].uuid === cardData.uuid) {
                        console.log('[History] Skipping hole card from count:', cardData.rank);
                        return; // Don't count hole card yet
                    }
                }

                // Convert rank from 'ACE' to 'A', 'TWO' to '2', etc.
                const rank = RankToAsset[cardData.rank];
                if (this.cardCounts[rank] !== undefined) {
                    this.cardCounts[rank]++;
                    this.totalCardsDealt++;
                    console.log(`[History] Card tracked: ${rank} (UUID: ${cardData.uuid}, holeCardHidden: ${this.holeCardHidden}, Total: ${this.totalCardsDealt})`);
                }
            }

            _showHistoryTab(tab) {
                if (tab === 'cardCount') {
                    this.el.tabCardCount.classList.add('active');
                    this.el.tabHandHistory.classList.remove('active');
                    this.el.cardCountPanel.classList.remove('hidden');
                    this.el.handHistoryPanel.classList.add('hidden');
                } else {
                    this.el.tabHandHistory.classList.add('active');
                    this.el.tabCardCount.classList.remove('active');
                    this.el.handHistoryPanel.classList.remove('hidden');
                    this.el.cardCountPanel.classList.add('hidden');
                }
            }

            _updateRulesDisplay() {
                // Update rules modal with current settings
                document.getElementById('rulesTarget').textContent = BlackjackRuleset.targetScore;
                document.getElementById('rulesDealerStand').textContent = BlackjackRuleset.dealerStandThreshold;
                document.getElementById('rulesDecks').textContent = BlackjackRuleset.deckCount;
                document.getElementById('rulesTargetSetting').textContent = BlackjackRuleset.targetScore;
                document.getElementById('rulesDealerStandSetting').textContent = BlackjackRuleset.dealerStandThreshold;
                document.getElementById('rulesReshuffle').textContent = this.reshuffleThreshold || 20;
            }

            _updateHistoryDisplay() {
                // Calculate cards remaining (6 decks = 312 cards)
                const totalCards = BlackjackRuleset.deckCount * 52;
                const remaining = totalCards - this.totalCardsDealt;

                // Update card count display with probabilities
                Object.keys(this.cardCounts).forEach(rank => {
                    const countEl = document.getElementById(`count${rank}`);
                    const probEl = document.getElementById(`prob${rank}`);

                    if (countEl) countEl.textContent = this.cardCounts[rank];

                    if (probEl && remaining > 0) {
                        // Calculate how many of this rank are left in the shoe
                        const cardsPerRank = BlackjackRuleset.deckCount * 4; // 4 of each rank per deck
                        const dealt = this.cardCounts[rank];
                        const leftInShoe = cardsPerRank - dealt;
                        const probability = (leftInShoe / remaining) * 100;

                        probEl.textContent = probability.toFixed(3) + '%';
                    } else if (probEl) {
                        probEl.textContent = '0.000%';
                    }
                });

                // Calculate combined 10-value probability (10, J, Q, K)
                const count10valEl = document.getElementById('count10val');
                const prob10valEl = document.getElementById('prob10val');

                if (count10valEl && prob10valEl) {
                    // Sum up dealt cards for 10, J, Q, K
                    const dealt10val = (this.cardCounts['10'] || 0) + (this.cardCounts['J'] || 0) +
                                      (this.cardCounts['Q'] || 0) + (this.cardCounts['K'] || 0);
                    count10valEl.textContent = dealt10val;

                    if (remaining > 0) {
                        // Calculate how many 10-value cards are left (4 ranks √ó 4 per deck per rank)
                        const total10val = BlackjackRuleset.deckCount * 4 * 4; // 4 ranks, 4 of each per deck
                        const left10val = total10val - dealt10val;
                        const probability = (left10val / remaining) * 100;

                        prob10valEl.textContent = probability.toFixed(3) + '%';
                    } else {
                        prob10valEl.textContent = '0.000%';
                    }
                }

                this.el.totalDealt.textContent = this.totalCardsDealt;
                this.el.cardsRemaining.textContent = remaining;

                // Update hand history list
                if (this.handHistory.length === 0) {
                    this.el.handHistoryList.innerHTML = '<div class="no-history">No hands played yet</div>';
                } else {
                    const hands = this.handHistory.map(hand => {
                        const playerCardsHTML = hand.playerCards.map(c =>
                            `<span class="history-card ${this._isRedSuit(c.suit) ? 'red' : ''}">${c.rank}${this._getSuitSymbol(c.suit)}</span>`
                        ).join('');

                        const dealerCardsHTML = hand.dealerCards.map(c =>
                            `<span class="history-card ${this._isRedSuit(c.suit) ? 'red' : ''}">${c.rank}${this._getSuitSymbol(c.suit)}</span>`
                        ).join('');

                        // Format payout with + or - and color
                        const payoutFormatted = hand.payout > 0 ? `+$${hand.payout}` :
                                               hand.payout < 0 ? `-$${Math.abs(hand.payout)}` :
                                               '$0';
                        const payoutClass = hand.payout > 0 ? 'win' : hand.payout < 0 ? 'lose' : 'push';

                        return `
                            <div class="history-hand">
                                <div class="history-hand-header">
                                    <span class="history-hand-num">Hand #${hand.number}</span>
                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 2px;">
                                        <span class="history-hand-result ${hand.outcome}">${this._formatOutcome(hand.outcome)}</span>
                                        <span class="history-hand-payout ${payoutClass}">${payoutFormatted}</span>
                                    </div>
                                </div>
                                <div class="history-cards-row">
                                    <div class="history-cards-label">Dealer (${hand.dealerValue})</div>
                                    <div class="history-cards">${dealerCardsHTML}</div>
                                </div>
                                <div class="history-cards-row">
                                    <div class="history-cards-label">You (${hand.playerValue})</div>
                                    <div class="history-cards">${playerCardsHTML}</div>
                                </div>
                            </div>
                        `;
                    }).reverse().join(''); // Reverse to show most recent first
                    this.el.handHistoryList.innerHTML = hands;
                }
            }

            _isRedSuit(suit) {
                return suit === 'HEARTS' || suit === 'DIAMONDS';
            }

            _getSuitSymbol(suit) {
                switch(suit) {
                    case 'HEARTS': return '‚ô•';
                    case 'DIAMONDS': return '‚ô¶';
                    case 'CLUBS': return '‚ô£';
                    case 'SPADES': return '‚ô†';
                    default: return '';
                }
            }

            _formatOutcome(outcome) {
                switch(outcome) {
                    case 'blackjack': return 'Blackjack!';
                    case 'win': return 'Win';
                    case 'lose': return 'Lose';
                    case 'push': return 'Push';
                    default: return outcome;
                }
            }

            _logHandResult(result) {
                this.handNumber++;
                const player = this.engine.players[0];
                const dealer = this.engine.dealer;

                // Capture the actual cards from hands
                const playerCards = player.hand.contents.map(c => ({
                    rank: RankToAsset[c.rank],
                    suit: c.suit
                }));

                const dealerCards = dealer.hand.contents.map(c => ({
                    rank: RankToAsset[c.rank],
                    suit: c.suit
                }));

                // Calculate payout (net gain/loss)
                const payout = Math.floor(result.bet * result.multiplier) - result.bet;

                this.handHistory.push({
                    number: this.handNumber,
                    outcome: result.outcome,
                    playerValue: result.playerValue,
                    dealerValue: result.dealerValue,
                    playerCards: playerCards,
                    dealerCards: dealerCards,
                    bet: result.bet,
                    payout: payout
                });

                console.log(`[History] Hand #${this.handNumber} logged:`, {
                    outcome: result.outcome,
                    playerCards: playerCards.length,
                    dealerCards: dealerCards.length,
                    payout: payout
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => new BlackjackUI());
    </script>
</body>
</html>