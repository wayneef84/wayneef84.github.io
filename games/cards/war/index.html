<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>War - Fong Family Arcade</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            height: 100dvh;
        }
        
        .header {
            background: rgba(0,0,0,0.4);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header h1 { margin: 0; font-size: 1.3em; }
        
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 8px;
            overflow: hidden;
        }
        
        .player-zone {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 10px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-zone.opponent {
            background: rgba(239,68,68,0.1);
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-name { font-weight: 600; }
        
        .card-count {
            background: rgba(0,0,0,0.3);
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.9em;
        }
        
        .card-count span { color: #fbbf24; font-weight: bold; }
        
        .deck-preview canvas {
            width: 50px;
            height: 70px;
            border-radius: 4px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }
        
        .battle-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
        }
        
        .battle-cards {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .battle-card {
            text-align: center;
        }
        
        .battle-card canvas {
            width: 90px;
            height: 126px;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }
        
        .battle-card .label {
            font-size: 0.8em;
            color: rgba(255,255,255,0.6);
            margin-top: 6px;
        }
        
        .vs-text {
            font-size: 1.5em;
            font-weight: bold;
            color: #ef4444;
        }
        
        .message {
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
            min-height: 40px;
        }
        
        .message.war {
            color: #ef4444;
            text-transform: uppercase;
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        .message.win { color: #4ade80; }
        .message.lose { color: #f87171; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .war-pot {
            background: rgba(239,68,68,0.2);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .controls {
            background: rgba(0,0,0,0.4);
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        
        .control-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .btn {
            padding: 16px 48px;
            font-size: 1.2em;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-transform: uppercase;
            transition: transform 0.15s ease;
        }
        
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn:not(:disabled):active { transform: scale(0.95); }
        
        .btn-flip {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-new {
            background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öîÔ∏è War</h1>
    </div>
    
    <div class="game-area">
        <div class="player-zone opponent">
            <div class="player-info">
                <span class="player-name">Opponent</span>
                <span class="card-count"><span id="oppCount">26</span> cards</span>
            </div>
            <div class="deck-preview" id="oppDeck"></div>
        </div>
        
        <div class="battle-zone">
            <div class="battle-cards" id="battleArea">
                <div class="battle-card">
                    <div id="oppCard"></div>
                    <div class="label">Opponent</div>
                </div>
                <div class="vs-text">VS</div>
                <div class="battle-card">
                    <div id="yourCard"></div>
                    <div class="label">You</div>
                </div>
            </div>
            <div class="message" id="message">Flip a card!</div>
            <div class="war-pot hidden" id="warPot">War pot: <span>0</span> cards</div>
        </div>
        
        <div class="player-zone">
            <div class="player-info">
                <span class="player-name">You</span>
                <span class="card-count"><span id="yourCount">26</span> cards</span>
            </div>
            <div class="deck-preview" id="yourDeck"></div>
        </div>
    </div>
    
    <div class="controls">
        <div class="control-row" id="playRow">
            <button class="btn btn-flip" id="btnFlip">Flip!</button>
        </div>
        <div class="control-row hidden" id="gameOverRow">
            <button class="btn btn-new" id="btnNew">Play Again</button>
        </div>
    </div>

    <script src="../shared/enums.js"></script>
    <script src="../shared/card.js"></script>
    <script src="../shared/deck.js"></script>
    <script src="../shared/pile.js"></script>
    <script src="../shared/player.js"></script>
    <script src="../shared/engine.js"></script>
    <script src="../shared/card-assets.js"></script>
    <script src="ruleset.js"></script>
    
    <script>
        (function() {
            'use strict';

            CardAssets.init();

            var WarUI = function() {
                this.engine = new GameEngine(WarRuleset);
                this.currentPlayer1Card = null;
                this.currentPlayer2Card = null;

                this.el = {
                    oppCount: document.getElementById('oppCount'),
                    yourCount: document.getElementById('yourCount'),
                    oppDeck: document.getElementById('oppDeck'),
                    yourDeck: document.getElementById('yourDeck'),
                    oppCard: document.getElementById('oppCard'),
                    yourCard: document.getElementById('yourCard'),
                    message: document.getElementById('message'),
                    warPot: document.getElementById('warPot'),
                    playRow: document.getElementById('playRow'),
                    gameOverRow: document.getElementById('gameOverRow'),
                    btnFlip: document.getElementById('btnFlip'),
                    btnNew: document.getElementById('btnNew')
                };

                this._bindEvents();
                this._subscribeToEngine();
                this._initGame();
            };

            WarUI.prototype._bindEvents = function() {
                var self = this;
                this.el.btnFlip.onclick = function() { self._flip(); };
                this.el.btnNew.onclick = function() { self._initGame(); };
            };

            WarUI.prototype._subscribeToEngine = function() {
                var self = this;
                this.engine.on('*', function(event) {
                    switch (event.type) {
                        case 'MESSAGE':
                            self._handleMessage(event);
                            break;
                        case 'RESOLUTION':
                            self._handleResolution(event);
                            break;
                        case 'GAME_OVER':
                            self._handleGameOver();
                            break;
                    }
                });
            };

            WarUI.prototype._initGame = function() {
                this.engine.init([
                    { id: 'player1', type: 'human', name: 'You' },
                    { id: 'player2', type: 'ai', name: 'Opponent' }
                ]);

                this._clearBattle();
                this._updateCounts();
                this._showMessage('Flip a card!', '');
                this.el.playRow.classList.remove('hidden');
                this.el.gameOverRow.classList.add('hidden');
                this.el.warPot.classList.add('hidden');

                this.currentPlayer1Card = null;
                this.currentPlayer2Card = null;
            };

            WarUI.prototype._flip = function() {
                var state = this.engine.getGameState();
                if (state.state === 'GAME_OVER' || state.state === 'RESOLUTION') return;

                var player1 = state.players[0];
                var player2 = state.players[1];

                if (player1.hand.count === 0 || player2.hand.count === 0) {
                    this.engine.transitionTo('RESOLUTION');
                    return;
                }

                // Store cards before they're moved
                this.currentPlayer1Card = player1.hand.contents[0];
                this.currentPlayer2Card = player2.hand.contents[0];

                // Render cards immediately
                this._renderCard(this.currentPlayer1Card, this.el.yourCard);
                this._renderCard(this.currentPlayer2Card, this.el.oppCard);

                // Submit action to engine
                this.engine.submitAction('player1', 'flip');
            };

            WarUI.prototype._handleMessage = function(event) {
                this._showMessage(event.text, this._getMessageClass(event.text));
                this._updateCounts();
                this._updateWarPot();
            };

            WarUI.prototype._handleResolution = function(event) {
                var self = this;
                setTimeout(function() {
                    self.engine.transitionTo('GAME_OVER');
                }, 800);
            };

            WarUI.prototype._handleGameOver = function() {
                var state = this.engine.getGameState();
                var resolution = state.resolution;

                if (!resolution) return;

                var player1 = state.players[0];
                var player2 = state.players[1];

                if (player1.hand.count > player2.hand.count) {
                    this._showMessage('üéâ You Win the War!', 'win');
                } else {
                    this._showMessage('Opponent Wins', 'lose');
                }

                this.el.playRow.classList.add('hidden');
                this.el.gameOverRow.classList.remove('hidden');
            };

            WarUI.prototype._renderCard = function(card, container) {
                var rankKey = RankToAsset[card.rank];
                var suitKey = SuitToAsset[card.suit];
                var canvas = CardAssets.getAsset(rankKey, suitKey);

                var clone = document.createElement('canvas');
                clone.width = canvas.width;
                clone.height = canvas.height;
                clone.getContext('2d').drawImage(canvas, 0, 0);

                container.innerHTML = '';
                container.appendChild(clone);
            };

            WarUI.prototype._renderCardBack = function(container) {
                var canvas = CardAssets.getAsset();
                var clone = document.createElement('canvas');
                clone.width = canvas.width;
                clone.height = canvas.height;
                clone.getContext('2d').drawImage(canvas, 0, 0);
                container.innerHTML = '';
                container.appendChild(clone);
            };

            WarUI.prototype._renderDecks = function() {
                var state = this.engine.getGameState();
                var player1 = state.players[0];
                var player2 = state.players[1];

                if (player1.hand.count > 0) {
                    this._renderCardBack(this.el.yourDeck);
                } else {
                    this.el.yourDeck.innerHTML = '';
                }
                if (player2.hand.count > 0) {
                    this._renderCardBack(this.el.oppDeck);
                } else {
                    this.el.oppDeck.innerHTML = '';
                }
            };

            WarUI.prototype._clearBattle = function() {
                this.el.yourCard.innerHTML = '';
                this.el.oppCard.innerHTML = '';
            };

            WarUI.prototype._updateCounts = function() {
                var state = this.engine.getGameState();
                var player1 = state.players[0];
                var player2 = state.players[1];

                this.el.yourCount.textContent = player1.hand.count;
                this.el.oppCount.textContent = player2.hand.count;
                this._renderDecks();
            };

            WarUI.prototype._updateWarPot = function() {
                var potSize = WarRuleset._warPot.count;
                this.el.warPot.querySelector('span').textContent = potSize;
                if (potSize > 0) {
                    this.el.warPot.classList.remove('hidden');
                } else {
                    this.el.warPot.classList.add('hidden');
                }
            };

            WarUI.prototype._showMessage = function(text, cls) {
                this.el.message.textContent = text;
                this.el.message.className = 'message ' + (cls || '');
            };

            WarUI.prototype._getMessageClass = function(text) {
                if (text.indexOf('You win') !== -1 || text.indexOf('Win') !== -1) return 'win';
                if (text.indexOf('Opponent wins') !== -1) return 'lose';
                if (text.indexOf('WAR') !== -1) return 'war';
                return '';
            };

            new WarUI();
        })();
    </script>
</body>
</html>
