<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Engine | Data Manager</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #00e676; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', monospace; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; height: 95vh; margin: 0; }

        /* Layout */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; background: var(--panel); padding: 10px; border-radius: 8px; align-items: center; }
        .editor-container { flex-grow: 1; position: relative; }

        /* Inputs & Buttons */
        input, select { background: #2c2c2c; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; flex-grow: 1; font-family: monospace; }
        button { background: #333; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #444; }
        button.primary { background: var(--accent); color: #000; }
        button.primary:hover { background: #00c853; }

        /* The Code Editor */
        textarea { width: 100%; height: 100%; background: #151515; color: #a9b7c6; border: 1px solid #333; border-radius: 8px; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; line-height: 1.5; resize: none; box-sizing: border-box; outline: none; }

        /* Status Bar */
        #status { font-size: 0.8rem; color: #888; margin-top: 5px; text-align: right; }
        .error { color: #ff5252; }
        .success { color: var(--accent); }
    </style>
</head>
<body>

    <div class="toolbar">
        <label>REMOTE:</label>
        <input type="text" id="urlInput" value="./packs/sprunki_v1.json" placeholder="Enter URL to JSON...">
        <button onclick="fetchUrl()">â¬‡ Fetch</button>
        <div style="width: 20px;"></div>
        <label>LOCAL DB:</label>
        <select id="savedPacks" onchange="loadFromDB()">
            <option value="">-- Select Saved Pack --</option>
        </select>
        <button class="primary" onclick="saveCurrentPack()">ðŸ’¾ Save to DB</button>
        <button style="background:#d32f2f;" onclick="deleteCurrentPack()">âœ• Delete</button>
    </div>

    <div class="editor-container">
        <textarea id="jsonEditor" spellcheck="false" placeholder="// JSON Data will appear here..."></textarea>
    </div>
    <div id="status">Ready</div>

    <script>
        // --- 1. INDEXEDDB MANAGER (The Works) ---
        const DB_NAME = 'J_QuizEngine_DB';
        const STORE_NAME = 'packs';
        let db;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);

                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: "id" });
                    }
                };

                request.onsuccess = (e) => {
                    db = e.target.result;
                    refreshDropdown();
                    resolve(db);
                };

                request.onerror = (e) => showStatus("DB Error: " + e.target.errorCode, true);
            });
        };

        // --- 2. CORE FUNCTIONS ---

        // Fetch from URL
        async function fetchUrl() {
            const url = document.getElementById('urlInput').value;
            showStatus(`Fetching ${url}...`);
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("HTTP " + response.status);
                const data = await response.json();

                // Format nicely
                document.getElementById('jsonEditor').value = JSON.stringify(data, null, 4);
                showStatus("Loaded from URL successfully.", false, true);

                // If the pack has an ID, try to select it in the dropdown if it exists
                if(data.meta && data.meta.id) {
                     // logic to highlight existing save could go here
                }
            } catch (err) {
                showStatus("Error loading URL: " + err.message, true);
                // Fallback for demo if file doesn't exist
                if (url.includes("sprunki")) loadDemoTemplate();
            }
        }

        // Save to IndexedDB
        function saveCurrentPack() {
            const raw = document.getElementById('jsonEditor').value;
            try {
                const data = JSON.parse(raw);

                // Validation: Must have an ID
                if (!data.meta || !data.meta.id) {
                    throw new Error("JSON must have a meta.id field to be saved.");
                }

                const tx = db.transaction([STORE_NAME], "readwrite");
                const store = tx.objectStore(STORE_NAME);
                const request = store.put({ id: data.meta.id, content: data, timestamp: new Date() });

                request.onsuccess = () => {
                    showStatus(`Saved pack '${data.meta.id}' to IndexedDB.`, false, true);
                    refreshDropdown(data.meta.id);
                };

                request.onerror = (e) => showStatus("Save Failed: " + e.target.error, true);

            } catch (err) {
                showStatus("Invalid JSON: " + err.message, true);
            }
        }

        // Load from IndexedDB
        function loadFromDB() {
            const id = document.getElementById('savedPacks').value;
            if (!id) return;

            const tx = db.transaction([STORE_NAME], "readonly");
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(id);

            request.onsuccess = () => {
                if (request.result) {
                    document.getElementById('jsonEditor').value = JSON.stringify(request.result.content, null, 4);
                    showStatus(`Loaded '${id}' from local storage.`);
                }
            };
        }

        // Delete from IndexedDB
        function deleteCurrentPack() {
            const id = document.getElementById('savedPacks').value;
            if (!id) return showStatus("Select a pack to delete first.", true);

            if(!confirm(`Permanently delete ${id}?`)) return;

            const tx = db.transaction([STORE_NAME], "readwrite");
            const store = tx.objectStore(STORE_NAME);
            store.delete(id);

            tx.oncomplete = () => {
                document.getElementById('jsonEditor').value = "";
                showStatus(`Deleted '${id}'.`);
                refreshDropdown();
            };
        }

        // --- 3. UTILITIES ---

        function refreshDropdown(selectedId = null) {
            const tx = db.transaction([STORE_NAME], "readonly");
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll(); // Get all records

            request.onsuccess = () => {
                const select = document.getElementById('savedPacks');
                select.innerHTML = '<option value="">-- Select Saved Pack --</option>';

                request.result.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.text = `${item.id} (${new Date(item.timestamp).toLocaleTimeString()})`;
                    if (item.id === selectedId) opt.selected = true;
                    select.appendChild(opt);
                });
            };
        }

        function showStatus(msg, isError = false, isSuccess = false) {
            const el = document.getElementById('status');
            el.innerText = msg;
            el.className = isError ? 'error' : (isSuccess ? 'success' : '');
            setTimeout(() => { if(isSuccess) el.className = ''; }, 3000);
        }

        function loadDemoTemplate() {
            const demo = {
                "meta": { "id": "sprunki_v1", "title": "Sprunki Demo", "version": "1.0" },
                "questions": [
                    { "id": "q1", "text": "Sample Question?", "options": {"A": "1", "B": "2"}, "correct": "A" }
                ]
            };
            document.getElementById('jsonEditor').value = JSON.stringify(demo, null, 4);
            showStatus("Loaded demo template (URL not found).");
        }

        // Boot
        window.onload = initDB;
    </script>
</body>
</html>