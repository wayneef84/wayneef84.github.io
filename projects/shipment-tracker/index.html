<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Multi-carrier shipment tracking with smart API rate limiting">
    <meta name="author" content="Wayne Fong (wayneef84)">
    <title>Shipment Tracker</title>

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/theme.css">
</head>
<body>
    <!-- Toast Container for Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Main Container -->
    <div class="container">

        <!-- Header -->
        <header class="header">
            <h1>üì¶ Shipment Tracker</h1>
            <div class="header-controls">
                <button id="refreshBtn" class="icon-btn" title="Refresh All">üîÑ</button>
                <button id="exportBtn" class="icon-btn" title="Export Data">üì§</button>
                <button id="settingsBtn" class="icon-btn" title="Settings">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Settings Panel (Hidden by default) -->
        <div id="settingsPanel" class="settings-panel hidden">
            <div class="panel-header">
                <h2>Settings</h2>
            </div>

            <div class="settings-content">

            <div class="settings-section">
                <h3>API Keys</h3>
                <p class="help-text">Enter your carrier API credentials. Keys are stored locally in your browser.</p>

                <label for="dhlApiKey">
                    <span>DHL API Key:</span>
                    <input type="password" id="dhlApiKey" placeholder="Enter DHL API key">
                    <button type="button" class="toggle-visibility" data-target="dhlApiKey">üëÅÔ∏è</button>
                </label>

                <label for="fedexClientId">
                    <span>FedEx Client ID:</span>
                    <input type="password" id="fedexClientId" placeholder="Enter FedEx client ID">
                    <button type="button" class="toggle-visibility" data-target="fedexClientId">üëÅÔ∏è</button>
                </label>

                <label for="fedexClientSecret">
                    <span>FedEx Client Secret:</span>
                    <input type="password" id="fedexClientSecret" placeholder="Enter FedEx client secret">
                    <button type="button" class="toggle-visibility" data-target="fedexClientSecret">üëÅÔ∏è</button>
                </label>

                <label for="upsApiKey">
                    <span>UPS API Key:</span>
                    <input type="password" id="upsApiKey" placeholder="Enter UPS API key">
                    <button type="button" class="toggle-visibility" data-target="upsApiKey">üëÅÔ∏è</button>
                </label>

                <label for="upsUsername">
                    <span>UPS Username:</span>
                    <input type="text" id="upsUsername" placeholder="Enter UPS username">
                </label>
            </div>

            <div class="settings-section">
                <h3>Query Engine</h3>

                <label for="cooldownMinutes">
                    <span>Cooldown (minutes):</span>
                    <input type="number" id="cooldownMinutes" min="1" max="60" value="10">
                </label>

                <label class="checkbox-label">
                    <input type="checkbox" id="skipDelivered" checked>
                    <span>Skip delivered shipments</span>
                </label>

                <label class="checkbox-label">
                    <input type="checkbox" id="enableForceRefresh" checked>
                    <span>Enable force refresh (ignores cooldown - uses more API calls)</span>
                </label>

                <label class="checkbox-label">
                    <input type="checkbox" id="skipRefreshConfirmation">
                    <span>Skip confirmation on force refresh</span>
                </label>
            </div>

            <div class="settings-section">
                <h3>Data Management</h3>

                <label for="pruneAfterDays">
                    <span>Auto-prune shipments older than (days):</span>
                    <input type="number" id="pruneAfterDays" min="30" max="365" value="90">
                </label>

                <label class="checkbox-label">
                    <input type="checkbox" id="autoPruneEnabled">
                    <span>Enable automatic pruning on app load</span>
                </label>

                <button id="pruneNowBtn" class="btn-secondary" style="margin-top: 0.5rem;">Prune Old Shipments Now</button>

                <p class="help-text" style="margin-top: 1rem;">‚ö†Ô∏è Warning: Clearing all data will permanently delete all tracking records and settings.</p>
                <button id="clearAllDataBtn" class="btn-danger">Clear All Data</button>
            </div>

            <div class="settings-section">
                <h3>Developer Tools</h3>
                <p class="help-text">Testing and debugging utilities</p>

                <button id="openDebugMenuBtn" class="btn-secondary" style="width: 100%;">
                    üõ†Ô∏è Open Debug Menu
                </button>

                <p class="help-text" style="margin-top: 0.5rem; font-size: 0.875rem;">
                    Keyboard shortcut: <kbd>Ctrl+Shift+D</kbd> (or <kbd>Cmd+Shift+D</kbd> on Mac)
                </p>
            </div>

            <div class="settings-actions">
                <button id="saveSettingsBtn" class="btn-primary">Save Settings</button>
                <button id="closeSettingsBtn" class="btn-secondary">Cancel</button>
            </div>
            </div>
        </div>

        <!-- Export Panel (Hidden by default) -->
        <div id="exportPanel" class="export-panel hidden">
            <h2>Export Data</h2>

            <div class="export-options">
                <button class="export-option" data-format="json">
                    <span class="export-icon">üìÑ</span>
                    <span class="export-label">JSON</span>
                    <span class="export-desc">Full backup with metadata</span>
                </button>

                <button class="export-option" data-format="csv">
                    <span class="export-icon">üìä</span>
                    <span class="export-label">CSV</span>
                    <span class="export-desc">Simple spreadsheet format</span>
                </button>

                <button class="export-option" data-format="excel">
                    <span class="export-icon">üìà</span>
                    <span class="export-label">Excel</span>
                    <span class="export-desc">Multi-sheet workbook</span>
                </button>
            </div>

            <div class="export-filters">
                <h3>Filter Options</h3>
                <label class="checkbox-label">
                    <input type="checkbox" id="exportOnlyActive">
                    <span>Export only active shipments</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="exportRawPayloads">
                    <span>Include raw API payloads (JSON only)</span>
                </label>
            </div>

            <div class="export-actions">
                <button id="closeExportBtn" class="btn-secondary">Close</button>
            </div>
        </div>

        <!-- Add Tracking Form -->
        <div class="add-tracking-section">
            <button type="button" id="mobileAddCloseBtn" class="mobile-add-close-btn" style="display: none;">‚úï</button>
            <form id="addTrackingForm" class="add-tracking-form">
                <div class="form-row">
                    <input
                        type="text"
                        id="awbInput"
                        placeholder="Enter tracking number (AWB)"
                        required
                        autocomplete="off"
                        oninput="window.app && window.app.detectCarrierFromAWB && window.app.detectCarrierFromAWB()">

                    <select id="carrierSelect">
                        <option value="">Auto-Detect Carrier</option>
                        <option value="DHL">DHL Express</option>
                        <option value="FedEx">FedEx</option>
                        <option value="UPS">UPS</option>
                        <option value="USPS">USPS</option>
                    </select>

                    <button type="submit" class="btn-primary">Add</button>

                    <input type="date" id="dateShipped" placeholder="Date Shipped">

                    <input type="file" id="importFile" accept=".json,.csv" style="display: none;">
                    <button type="button" id="importBtn" class="btn-secondary btn-icon-expand" title="Import from File">
                        <span class="icon">üì•</span>
                        <span class="text">Import</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Statistics Dashboard -->
        <div id="statsContainer" class="stats-container hidden">
            <div class="stat-card stat-card-compact" data-filter="total" id="statCardTotal">
                <span class="stat-label-compact">Total:</span>
                <span class="stat-value-compact" id="statTotal">0</span>
            </div>
            <div class="stat-card stat-card-compact" data-filter="active" id="statCardActive">
                <span class="stat-label-compact">Active:</span>
                <span class="stat-value-compact" id="statActive">0</span>
            </div>
            <div class="stat-card stat-card-compact" data-filter="delivered" id="statCardDelivered">
                <span class="stat-label-compact">Delivered:</span>
                <span class="stat-value-compact" id="statDelivered">0</span>
            </div>
            <div class="stat-card stat-card-compact" data-filter="exception" id="statCardException">
                <span class="stat-label-compact">Issues:</span>
                <span class="stat-value-compact" id="statException">0</span>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <label for="filterCarrier">Carrier:</label>
                <select id="filterCarrier">
                    <option value="">All</option>
                    <option value="DHL">DHL</option>
                    <option value="FedEx">FedEx</option>
                    <option value="UPS">UPS</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filterStatus">Status:</label>
                <select id="filterStatus">
                    <option value="">All</option>
                    <option value="PICKUP">Awaiting Pickup</option>
                    <option value="IN_TRANSIT">In Transit</option>
                    <option value="OUT_FOR_DELIVERY">Out for Delivery</option>
                    <option value="DELIVERY">Delivered</option>
                    <option value="EXCEPTION">Exception</option>
                    <option value="FAILED">Failed</option>
                </select>
            </div>

            <div class="filter-group filter-group-search hidden" id="searchContainer">
                <input type="text" id="searchInput" placeholder="Search AWB...">
            </div>

            <button type="button" id="searchToggleBtn" class="icon-btn" title="Toggle Search">üîç</button>
        </div>

        <!-- Debug Menu (Ctrl+Shift+D to toggle) -->
        <div id="debugMenu" class="debug-menu" style="display: none;">
            <div class="debug-header">
                <h3>üõ†Ô∏è Debug Menu</h3>
                <button type="button" id="debugCloseBtn" class="debug-close-btn">‚úï</button>
            </div>
            <div class="debug-content">
                <div class="debug-section">
                    <h4>Load Test Dataset</h4>
                    <button type="button" class="debug-btn" id="loadMixedDataset">Load Mixed Scenarios (6 shipments)</button>
                    <button type="button" class="debug-btn" id="loadDHLDataset">Load DHL Test Numbers (6 shipments)</button>
                    <button type="button" class="debug-btn" id="loadFedExDataset">Load FedEx Test Numbers (3 shipments)</button>
                    <button type="button" class="debug-btn" id="loadUPSDataset">Load UPS Test Numbers (3 shipments)</button>
                </div>
                <div class="debug-section">
                    <h4>Quick Add Single Tracking</h4>
                    <button type="button" class="debug-btn debug-btn-sm" id="addDHLActive">DHL - Active</button>
                    <button type="button" class="debug-btn debug-btn-sm" id="addDHLDelivered">DHL - Delivered</button>
                    <button type="button" class="debug-btn debug-btn-sm" id="addFedExTransit">FedEx - In Transit</button>
                    <button type="button" class="debug-btn debug-btn-sm" id="addFedExException">FedEx - Exception</button>
                    <button type="button" class="debug-btn debug-btn-sm" id="addUPSOutForDelivery">UPS - Out for Delivery</button>
                    <button type="button" class="debug-btn debug-btn-sm" id="addUPSDelivered">UPS - Delivered</button>
                </div>
                <div class="debug-section">
                    <h4>Actions</h4>
                    <button type="button" class="debug-btn debug-btn-warning" id="refreshAllTracking">Refresh All Trackings</button>
                    <button type="button" class="debug-btn debug-btn-danger" id="clearAllData">Clear All Data</button>
                </div>
                <div class="debug-section">
                    <h4>Test Pages</h4>
                    <a href="test.html" target="_blank" class="debug-btn" style="display: block; text-decoration: none; text-align: center;">üß™ API Test Page</a>
                    <a href="test-tracking.html" target="_blank" class="debug-btn" style="display: block; text-decoration: none; text-align: center;">üìä Tracking Test Page</a>
                </div>
                <div class="debug-section">
                    <h4>Info</h4>
                    <div class="debug-info">
                        <span id="debugTrackingCount">Trackings: 0</span> |
                        <span id="debugDBSize">DB Size: 0 KB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Bottom Bar (2 rows: actions top, stat filters bottom) -->
        <div id="mobileBottomBar" class="mobile-bottom-bar" style="display: none;">
            <!-- Row 1: Actions (Add, Filter, Sort) -->
            <div class="bottom-bar-row actions">
                <button type="button" class="bottom-bar-btn action-btn" id="mobileAddToggle" title="Add Tracking">
                    <span class="btn-icon">‚ûï</span>
                    <span class="btn-label">Add</span>
                </button>
                <button type="button" class="bottom-bar-btn action-btn" id="mobileFilterToggle" title="Search & Filter">
                    <span class="btn-icon">üîç</span>
                    <span class="btn-label">Filter</span>
                </button>
                <button type="button" class="bottom-bar-btn action-btn" id="mobileSortToggle" title="Sort By">
                    <span class="btn-icon">‚ÜïÔ∏è</span>
                    <span class="btn-label">Sort</span>
                </button>
            </div>

            <!-- Row 2: Stat Filters (Active, Delivered, Issues, Total) -->
            <div class="bottom-bar-row stat-filters">
                <button type="button" class="bottom-bar-btn stat-filter-btn" data-filter="active" id="filterActive" title="Active Shipments">
                    <span class="btn-icon">üöö</span>
                    <span class="btn-count" id="countActive">0</span>
                </button>
                <button type="button" class="bottom-bar-btn stat-filter-btn" data-filter="delivered" id="filterDelivered" title="Delivered">
                    <span class="btn-icon">‚úÖ</span>
                    <span class="btn-count" id="countDelivered">0</span>
                </button>
                <button type="button" class="bottom-bar-btn stat-filter-btn" data-filter="exception" id="filterIssues" title="Issues & Exceptions">
                    <span class="btn-icon">‚ö†Ô∏è</span>
                    <span class="btn-count" id="countIssues">0</span>
                </button>
                <button type="button" class="bottom-bar-btn stat-filter-btn" data-filter="total" id="filterTotal" title="Total Shipments">
                    <span class="btn-icon">üì¶</span>
                    <span class="btn-count" id="countTotal">0</span>
                </button>
            </div>
        </div>

        <!-- Mobile Sort Menu (slides up from bottom) -->
        <div id="mobileSortMenu" class="mobile-sort-menu" style="display: none;">
            <div class="sort-menu-header">
                <h3>Sort By</h3>
                <button type="button" id="closeSortMenuBtn" class="close-btn">‚úï</button>
            </div>
            <div class="sort-menu-options">
                <button type="button" class="sort-option" data-sort="awb" data-direction="asc">
                    <span class="sort-label">AWB</span>
                    <span class="sort-direction">A ‚Üí Z</span>
                </button>
                <button type="button" class="sort-option" data-sort="carrier" data-direction="asc">
                    <span class="sort-label">Carrier</span>
                    <span class="sort-direction">A ‚Üí Z</span>
                </button>
                <button type="button" class="sort-option" data-sort="status" data-direction="asc">
                    <span class="sort-label">Status</span>
                    <span class="sort-direction">A ‚Üí Z</span>
                </button>
                <button type="button" class="sort-option" data-sort="estimatedDelivery" data-direction="asc">
                    <span class="sort-label">Est. Delivery</span>
                    <span class="sort-direction">Soonest First</span>
                </button>
                <button type="button" class="sort-option" data-sort="lastUpdated" data-direction="desc">
                    <span class="sort-label">Last Updated</span>
                    <span class="sort-direction">Newest First</span>
                </button>
            </div>
        </div>

        <!-- Mobile Cards Container (shown on mobile) -->
        <div id="mobileCardsContainer" class="mobile-cards-container">
            <!-- Cards populated by JavaScript -->
        </div>

        <!-- Content Wrapper (for split view on desktop) -->
        <div class="content-wrapper">
            <!-- Desktop Table Container (shown on desktop) -->
            <div class="table-container">
            <table id="trackingTable">
                <thead>
                    <tr>
                        <th data-sort="awb" class="sortable">AWB <span class="sort-indicator"></span></th>
                        <th data-sort="carrier" class="sortable">Carrier <span class="sort-indicator"></span></th>
                        <th class="status-icon-column"></th>
                        <th data-sort="status" class="status-text-column sortable">Status <span class="sort-indicator"></span></th>
                        <th data-sort="origin" class="sortable">Origin <span class="sort-indicator"></span></th>
                        <th data-sort="destination" class="sortable">Destination <span class="sort-indicator"></span></th>
                        <th data-sort="estimatedDelivery" class="sortable">Est. Delivery <span class="sort-indicator"></span></th>
                        <th data-sort="lastUpdated" class="sortable">Last Updated <span class="sort-indicator"></span></th>
                        <th class="actions-column">Actions</th>
                    </tr>
                </thead>
                <tbody id="trackingTableBody">
                    <!-- Rows populated by JavaScript -->
                </tbody>
            </table>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <div class="empty-icon">üì¶</div>
                <h3>No Tracking Data</h3>
                <p>Add your first tracking number above to get started.</p>
            </div>
        </div>

        <!-- Detail Panel (Slide-in) -->
        <div id="detailPanel" class="detail-panel hidden">
            <div class="detail-header">
                <h2 id="detailAWB">Tracking Details</h2>
                <button id="closeDetailBtn" class="icon-btn">‚úï</button>
            </div>

            <div class="detail-content">
                <div class="detail-section">
                    <h3>Shipment Info</h3>
                    <dl id="detailInfo">
                        <!-- Populated by JavaScript -->
                    </dl>
                </div>

                <div class="detail-section">
                    <h3>Event History</h3>
                    <div id="detailEvents" class="event-timeline">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="detail-section">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Raw Payload</h3>
                        <button id="downloadPayloadBtn" class="btn-secondary btn-icon-expand" title="Download JSON">
                            <span class="icon">üì•</span>
                            <span class="text">Download JSON</span>
                        </button>
                    </div>
                    <div id="payloadViewer" class="payload-viewer">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="detail-actions">
                    <button id="forceRefreshBtn" class="btn-primary">Force Refresh</button>
                    <button id="deleteTrackingBtn" class="btn-danger">Delete</button>
                </div>
            </div>

            <!-- Back to Top Button -->
            <button id="detailBackToTop" class="back-to-top-btn" title="Back to Top">‚Üë</button>
        </div>
        </div><!-- End content-wrapper -->

    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>
            Created by <a href="https://github.com/wayneef84" target="_blank">Wayne Fong (wayneef84)</a>
            with <a href="https://claude.ai/code" target="_blank">Claude Code</a>
        </p>
        <p class="legal">
            <a href="LICENSE" target="_blank">License</a> |
            <a href="https://developer.dhl.com/legal" target="_blank">DHL Terms</a> |
            <a href="https://developer.fedex.com/terms" target="_blank">FedEx Terms</a> |
            <a href="https://www.ups.com/upsdeveloperkit" target="_blank">UPS Terms</a>
        </p>
    </footer>

    <!-- Scripts -->
    <script src="js/db.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/normalizer.js"></script>
    <script src="js/api/base.js"></script>
    <script src="js/api/dhl.js"></script>
    <script src="js/api/fedex.js"></script>
    <script src="js/api/ups.js"></script>
    <script src="js/debug.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
